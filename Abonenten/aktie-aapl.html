<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Apple — capitovo</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <!-- Page-specific layout and focus styles moved to global `style.css` -->
</head>
<body class="bg-white text-gray-900 abonenten-page">

  <header>
    <div class="header-content">
        <div class="logo">
        <a href="./abonenten.html">
          <img src="../caitavo_logo_weiß.png" alt="capitovo Logo" class="header-logo">
        </a>
      </div>
      <button class="menu-toggle" id="menu-toggle" aria-controls="sidebar" aria-expanded="false" aria-label="Menü öffnen">
        &#9776;
      </button>
    </div>
  </header>

  <!-- Sidebar (kept from Abonenten page) -->
  <div class="sidebar" id="sidebar" aria-hidden="true" aria-label="Seitenmenü">
      <button class="close-button" id="close-sidebar" aria-label="Sidebar schließen">&times;</button>
      <nav class="sidebar-nav" aria-label="Hauptnavigation">
          <ul>
              <li>
                  <a href="./abonenten.html" class="flex items-center space-x-3" aria-label="Startseite">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M3 11.5L12 4l9 7.5" />
                          <path d="M5 10.5v7.5a1 1 0 001 1h3v-5h6v5h3a1 1 0 001-1v-7.5" />
                      </svg>
                      <span>Startseite</span>
                  </a>
              </li>
              <li>
                  <div>
                      <a href="./konto.html" class="flex items-center space-x-3" aria-label="Mein Konto">
                          <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                              <circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5" />
                              <path d="M6 20c0-3.333 3.333-6 6-6s6 2.667 6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                          <span>Mein Konto</span>
                      </a>
                  </div>
              </li>
              <li>
                  <a href="./alle_analysen.html" class="flex items-center space-x-3">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="10" width="4" height="11" rx="0.5" /><rect x="10" y="6" width="4" height="15" rx="0.5" /><rect x="17" y="3" width="4" height="18" rx="0.5" /></svg>
                      <span>Analysen</span>
                  </a>
              </li>
              <li>
                  <a href="./aktien-monitor.html" class="flex items-center space-x-3">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M3 17l6-6 4 4 8-8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                          <polyline points="3 17 9 11 13 15 21 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                      </svg>
                      <span>Aktien‑Monitor</span>
                  </a>
              </li>
              <li>
                  <a href="./earnings_kalender.html" class="flex items-center space-x-3">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                          <line x1="16" y1="2" x2="16" y2="6"></line>
                          <line x1="8" y1="2" x2="8" y2="6"></line>
                          <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span>Wirtschaftskalender</span>
                  </a>
              </li>
              <li class="logout-bottom">
                  <a href="#" id="open-contact-modal" class="flex items-center space-x-3" aria-label="Kontakt aufnehmen">
                      <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M22 6l-10 7L2 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span>Kontakt</span>
                  </a>
              </li>

              <li class="logout-bottom">
                  <a href="#" id="logout-link" class="logout-link" aria-label="Abmelden">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                          <path d="M16 17l5-5-5-5" />
                          <path d="M21 12H9" />
                      </svg>
                      <span>Abmelden</span>
                  </a>
              </li>
          </ul>
      </nav>
  </div>

  <!-- Hauptinhalt: Artikel/Chart-Platzhalter (aligned with site content) -->
  <main class="max-w-6xl mx-auto p-6">
        <section class="member-grid">
            <div class="bg-white p-6 rounded-xl shadow analyses-box" style="width:calc(100% - 12px);">
                <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-semibold">Apple Inc.</h2>
                  <a href="./aktien-monitor.html" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 ml-4" aria-label="Zurück zur Übersicht">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 18l-6-6 6-6"/></svg>
                    <span>Zurück zur Übersicht</span>
                  </a>
                </div>

                    <div class="mb-4">
                    <div class="flex flex-col md:flex-row md:items-stretch md:gap-6">
                        <!-- Left: description (takes remaining space) -->
                        <div id="description-col" class="md:flex-1 text-gray-700">
                            <p class="text-gray-600 mb-3">Apple ist eines der weltweit führenden Technologieunternehmen und steht für Innovation, Design und digitale Lösungen. Das Unternehmen wurde 1976 gegründet und ist heute bekannt für seine Produkte wie iPhone, iPad, Mac, Apple Watch und AirPods, die weltweit Millionen von Nutzern begeistern.</p>
                            <p class="text-gray-600 mb-3">Neben Hardware bietet Apple auch eine Vielzahl digitaler Dienstleistungen an, darunter den App Store, Apple Music, iCloud und Apple Pay, die einen immer größeren Anteil am Geschäftsmodell einnehmen. Das Unternehmen zeichnet sich durch eine starke Markenloyalität und eine globale Präsenz aus.</p>
                            <p class="text-gray-600 mb-0">Die Produkte von Apple sind nicht nur technisch fortschrittlich, sondern auch für ihr einzigartiges Design und die einfache Bedienung bekannt. Apple setzt zudem auf Nachhaltigkeit und Datenschutz, was die Marke bei vielen Kunden zusätzlich stärkt. Mit Sitz in Cupertino, Kalifornien, beschäftigt das Unternehmen Zehntausende Mitarbeiter und betreibt Geschäfte in fast allen Ländern der Welt.</p>
                        </div>

                        <!-- Right: chart (flexible width on md+, full width on small screens) -->
                        <div class="mt-4 md:mt-0" style="flex:0 0 40%; max-width:40%;">
                          <div id="tv-container" class="tradingview-widget-container card h-full" style="width:100%; height:100%;" role="region" aria-label="Aktueller Kurs und Chart">
      <div class="tradingview-widget-container__widget"></div>
      <script>
        (function(){
          var cfg = {
            "lineWidth": 2,
            "lineType": 0,
            "chartType": "area",
            "fontColor": "rgb(106, 109, 120)",
            "gridLineColor": "rgba(255, 255, 255, 0)",
            "volumeUpColor": "rgba(34, 171, 148, 0.5)",
            "volumeDownColor": "rgba(247, 82, 95, 0.5)",
            "backgroundColor": "#ffffff",
            "widgetFontColor": "#0F0F0F",
            "upColor": "#22ab94",
            "downColor": "#f7525f",
            "borderUpColor": "#22ab94",
            "borderDownColor": "#f7525f",
            "wickUpColor": "#22ab94",
            "wickDownColor": "#f7525f",
            "colorTheme": "light",
            "isTransparent": true,
            "locale": "de_DE",
            "chartOnly": false,
            "scalePosition": "right",
            "scaleMode": "Normal",
            "fontFamily": "-apple-system, BlinkMacSystemFont, Trebuchet MS, Roboto, Ubuntu, sans-serif",
            "valuesTracking": "1",
            "changeMode": "price-and-percent",
            "symbols": [["GETTEX:APC|1D"]],
            "dateRanges": ["1d|1","1w|15","1m|30","12m|1D","60m|1W","all|1M"],
            "fontSize": "10",
            "headerFontSize": "medium",
            "autosize": false,
            "dateFormat": "dd/MM/yyyy",
            "width": "100%",
            "height": 400,
            "noTimeScale": false,
            "hideDateRanges": false,
            "hideMarketStatus": false,
            "hideSymbolLogo": false
          };
          var s = document.createElement('script'); s.type='text/javascript'; s.async=true;
          s.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
          s.text = JSON.stringify(cfg);
          var target = document.getElementById('tv-container'); if(target) target.appendChild(s);
        })();
      </script>
    </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-lg font-semibold">Apple Finanzdaten</h3>
                </div>
                <div id="financials-overview" class="mb-6 p-4 bg-white rounded" style="border:1px solid rgba(15,23,42,0.04); height:560px; overflow:visible;" role="region" aria-label="Apple Finanzdaten">
                  <!-- Financials widget wird programmgesteuert eingefügt -->
                    <noscript>
                      <div style="padding:0.5rem;font-size:0.95rem;color:#6b7280;">Financials: Bitte aktiviere JavaScript, um detaillierte Finanzdaten zu sehen.</div>
                    </noscript>
                </div>

                <!-- Aktions-Buttons entfernt auf Wunsch des Nutzers -->
            </div>
        </section>
    </main>

    <footer id="abo" class="site-footer" data-scroll="fade-up" data-scroll-delay="40">
      <div class="footer-inner max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row items-center justify-between gap-4">
        <p class="copyright text-sm text-gray-600">&copy; 2024 capitovo. Wachstum durch Wissen.</p>

        <div class="footer-links flex items-center gap-3">
          <a href="../Rechtliches/impressum.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Impressum</a>
          <a href="../Rechtliches/datenschutz.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Datenschutz</a>
          <a href="../Rechtliches/haftung.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Haftungsausschluss</a>
          <a href="../Rechtliches/agb.html" class="footer-btn" target="_blank" rel="noopener noreferrer">AGB</a>
        </div>
      </div>
    </footer>

  <script src="../src/components/insert_components.js"></script>
  <script>
    // Inline FMP API key so the page can fetch financials without additional setup
    // (set by assistant per user request). This is local to the dev container.
    window.FMP_API_KEY = 'OQ6IIDD26Cnm3fPtXiQw8O05ZAaBPFRI';
  </script>
  <script src="../src/config.js"></script>
  <script>
    // Sidebar toggle wiring (single, shared handler)
    document.addEventListener('click', function(e){
      var toggle = e.target.closest('#menu-toggle, .menu-toggle, [aria-controls="sidebar"]');
      if(toggle){
        var sb = document.getElementById('sidebar'); if(!sb) return;
        var isHidden = sb.getAttribute('aria-hidden') === 'true';
        // toggle aria-hidden and the visible class
        sb.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
        if(isHidden) sb.classList.add('open'); else sb.classList.remove('open');
        return;
      }

      var closeTrigger = e.target.closest('#close-sidebar, #logout-link');
      if(closeTrigger){
        var sb2 = document.getElementById('sidebar'); if(!sb2) return;
        sb2.setAttribute('aria-hidden','true'); sb2.classList.remove('open');
        return;
      }
    });
  </script>

  <!-- Footer (already present above) - component include removed to avoid duplication -->

  <script>
    // Financials widget (symbol for Apple)
      (function(){
      // Wechsel auf 'regular' – height: '100%' damit das Embed die Container-Höhe übernimmt
      var cfg = { symbol: 'NASDAQ:AAPL', colorTheme: 'light', displayMode: 'regular', isTransparent: true, locale: 'de_DE', width: '100%', height: '100%' };
      var s = document.createElement('script'); s.type='text/javascript'; s.async=true;
      s.src = 'https://s3.tradingview.com/external-embedding/embed-widget-financials.js'; s.text = JSON.stringify(cfg);
      var target = document.getElementById('financials-overview'); if(target) target.appendChild(s);
    })();
  </script>

  <script>
    // Beobachte den financials-overview Container und wende das 3x3-Grid an,
    // sobald mindestens 9 Kindelemente (Datenkästchen) vorhanden sind.
    (function(){
      var container = document.getElementById('financials-overview');
      if(!container) return;

      var applyGrid = function(){
        // 1) Direkte Kinder prüfen
        var direct = Array.from(container.children).filter(function(n){
          return !(n.tagName==='SCRIPT' || n.tagName==='NOSCRIPT' || (n.nodeType===3 && !/\S/.test(n.nodeValue)));
        });
        if(direct.length >= 9){
          container.classList.add('three-by-three');
          return true;
        }

        // 2) Suche verschachtelte Wrapper, die 9+ Kindelemente enthalten
        var all = container.querySelectorAll('*');
        for(var i=0;i<all.length;i++){
          var el = all[i];
          // ignore script/noscript nodes
          if(el.tagName==='SCRIPT' || el.tagName==='NOSCRIPT') continue;
          var childElems = Array.from(el.children).filter(function(n){ return !(n.tagName==='SCRIPT' || n.tagName==='NOSCRIPT'); });
          if(childElems.length >= 9){
            // Setze die Klasse auf das innere Wrapper-Element
            el.classList.add('three-by-three-inner');
            return true;
          }
        }

        // 3) Falls ein iframe vorhanden ist, erkennen wir, dass das Embed in einem iframe läuft
        // und nicht von außen gestylt werden kann. Wir brechen dann ab.
        if(container.querySelector('iframe')){
          // optional: markiere container zur leichteren Diagnose
          container.classList.add('financials-iframe');
          return false;
        }

        return false;
      };

      // Try immediate (fast path)
      if(applyGrid()) return;

      // MutationObserver beobachtet Einfügungen innerhalb des Containers
      var mo = new MutationObserver(function(muts){
        if(applyGrid()){
          mo.disconnect();
        }
      });
      mo.observe(container, { childList: true, subtree: true });

      // Safety fallback nach 3s
      setTimeout(function(){ applyGrid(); mo.disconnect(); }, 3000);
    })();
  </script>

  <script>
    // Fallback: wenn TradingView kein 3x3 liefert (oder ein iframe verwendet),
    // rendern wir eigene 9 Kästchen. Optional: wenn `window.FMP_API_KEY` gesetzt ist,
    // versuchen wir, Daten von FinancialModelingPrep zu holen.
    (function(){
      var container = document.getElementById('financials-overview');
      if(!container) return;

      function createBox(title, value, sub){
        var box = document.createElement('div');
        box.className = 'financial-box p-3 bg-white rounded';
        var t = document.createElement('div'); t.className='fb-title'; t.textContent = title;
        var v = document.createElement('div'); v.className='fb-value'; v.textContent = value;
        box.appendChild(t); box.appendChild(v);
        if(sub){ var s = document.createElement('div'); s.className='fb-sub'; s.textContent = sub; box.appendChild(s); }
        return box;
      }

      function renderFallback(data){
        // remove existing children that are scripts/noscript to avoid clutter
        Array.from(container.querySelectorAll('script,noscript')).forEach(function(n){ n.remove(); });
        // hide any iframe (we will render our boxes instead)
        var ifr = container.querySelector('iframe'); if(ifr) ifr.style.display='none';

        // clear non-visual nodes
        // create grid container if not already
        container.classList.add('three-by-three');
        // remove existing element children (keep container)
        Array.from(container.children).forEach(function(ch){ ch.remove(); });

        for(var i=0;i<9;i++){
          var d = data && data[i] ? data[i] : { title: ['Market Cap','KGV','Umsatz','EPS','Free Cash Flow','EBITDA','Net Income','Dividende','Operative Marge'][i], value: ['–','–','–','–','–','–','–','–','–'][i], sub: '' };
          container.appendChild(createBox(d.title, d.value, d.sub));
        }
      }

      // Try to fetch from FinancialModelingPrep if API key is provided locally,
      // or use the server proxy if available at /api/financials/:symbol
      var localApiKey = window.FMP_API_KEY || null;
      var proxyAvailable = true; // assume proxy may be started by developer at /server
      var apiKey = localApiKey;
      if(apiKey){
        var symbol = 'AAPL';
        var profileUrl = 'https://financialmodelingprep.com/api/v3/profile/' + symbol + '?apikey=' + apiKey;
        var incomeUrl = 'https://financialmodelingprep.com/api/v3/income-statement/' + symbol + '?limit=1&apikey=' + apiKey;
        var cashUrl = 'https://financialmodelingprep.com/api/v3/cash-flow-statement/' + symbol + '?limit=1&apikey=' + apiKey;
        var ratiosUrl = 'https://financialmodelingprep.com/api/v3/ratios-ttm/' + symbol + '?limit=1&apikey=' + apiKey;

        function fmtNumber(n){
          if(n===null||n===undefined||n==='') return '–';
          if(typeof n !== 'number') n = Number(n);
          if(!isFinite(n)) return '–';
          // billions
          if(Math.abs(n) >= 1e9) return (Math.round((n/1e9)*10)/10) + ' Mrd';
          if(Math.abs(n) >= 1e6) return (Math.round((n/1e6)*10)/10) + ' Mio';
          return new Intl.NumberFormat('de-DE').format(Math.round(n));
        }

        // If a local key is not present, try the server proxy endpoint first
        if(!apiKey && proxyAvailable){
          fetch('/api/financials/' + symbol).then(function(r){
            if(!r.ok) throw new Error('proxy-not-available');
            return r.json();
          }).then(function(payload){
            var profile = payload.profile && payload.profile[0] ? payload.profile[0] : {};
            var income = payload.income && payload.income[0] ? payload.income[0] : {};
            var cash = payload.cash && payload.cash[0] ? payload.cash[0] : {};
            var ratios = payload.ratios && payload.ratios[0] ? payload.ratios[0] : {};
            var data = [
              { title: 'Marktkapitalisierung', value: profile.mktCap ? fmtNumber(profile.mktCap) : '–' },
              { title: 'KGV (PE)', value: profile.pe ? (Math.round(profile.pe*10)/10) : (ratios.priceEarningsRatio ? ratios.priceEarningsRatio : '–') },
              { title: 'Umsatz (letzte Periode)', value: income.revenue ? fmtNumber(income.revenue) : '–' },
              { title: 'EPS', value: (income.eps || profile.eps) ? (Math.round((income.eps||profile.eps)*100)/100) : '–' },
              { title: 'Free Cash Flow', value: cash.freeCashFlow ? fmtNumber(cash.freeCashFlow) : '–' },
              { title: 'EBITDA', value: income.ebitda ? fmtNumber(income.ebitda) : '–' },
              { title: 'Nettoergebnis', value: income.netIncome ? fmtNumber(income.netIncome) : '–' },
              { title: 'Dividende (letzter)', value: profile.lastDiv ? profile.lastDiv : (profile.dividendYield ? (Math.round(profile.dividendYield*1000)/10)+'%' : '–') },
              { title: 'Operative Marge', value: ratios.operatingMargin ? (Math.round(ratios.operatingMargin*1000)/10)+'%' : (ratios.operatingProfitMargin ? (Math.round(ratios.operatingProfitMargin*1000)/10)+'%' : '–') }
            ];
            renderFallback(data);
          }).catch(function(){
            // Proxy not available or failed — fallback to client-side calls if API key present
            Promise.all([
              fetch(profileUrl).then(function(r){ return r.json(); }),
              fetch(incomeUrl).then(function(r){ return r.json(); }),
              fetch(cashUrl).then(function(r){ return r.json(); }),
              fetch(ratiosUrl).then(function(r){ return r.json(); })
            ]).then(function(results){
              try{
                var profile = results[0] && results[0][0] ? results[0][0] : {};
                var income = results[1] && results[1][0] ? results[1][0] : {};
                var cash = results[2] && results[2][0] ? results[2][0] : {};
                var ratios = results[3] && results[3][0] ? results[3][0] : {};

                var data = [
                  { title: 'Marktkapitalisierung', value: profile.mktCap ? fmtNumber(profile.mktCap) : '–' },
                  { title: 'KGV (PE)', value: profile.pe ? (Math.round(profile.pe*10)/10) : (ratios.priceEarningsRatio ? ratios.priceEarningsRatio : '–') },
                  { title: 'Umsatz (letzte Periode)', value: income.revenue ? fmtNumber(income.revenue) : '–' },
                  { title: 'EPS', value: (income.eps || profile.eps) ? (Math.round((income.eps||profile.eps)*100)/100) : '–' },
                  { title: 'Free Cash Flow', value: cash.freeCashFlow ? fmtNumber(cash.freeCashFlow) : '–' },
                  { title: 'EBITDA', value: income.ebitda ? fmtNumber(income.ebitda) : '–' },
                  { title: 'Nettoergebnis', value: income.netIncome ? fmtNumber(income.netIncome) : '–' },
                  { title: 'Dividende (letzter)', value: profile.lastDiv ? profile.lastDiv : (profile.dividendYield ? (Math.round(profile.dividendYield*1000)/10)+'%' : '–') },
                  { title: 'Operative Marge', value: ratios.operatingMargin ? (Math.round(ratios.operatingMargin*1000)/10)+'%' : (ratios.operatingProfitMargin ? (Math.round(ratios.operatingProfitMargin*1000)/10)+'%' : '–') }
                ];

                renderFallback(data);
              }catch(e){ renderFallback(); }
            }).catch(function(){ renderFallback(); });
          });
          return;
        }

        // client-side requests using local API key
        Promise.all([
          fetch(profileUrl).then(function(r){ return r.json(); }),
          fetch(incomeUrl).then(function(r){ return r.json(); }),
          fetch(cashUrl).then(function(r){ return r.json(); }),
          fetch(ratiosUrl).then(function(r){ return r.json(); })
        ]).then(function(results){
          try{
            var profile = results[0] && results[0][0] ? results[0][0] : {};
            var income = results[1] && results[1][0] ? results[1][0] : {};
            var cash = results[2] && results[2][0] ? results[2][0] : {};
            var ratios = results[3] && results[3][0] ? results[3][0] : {};

            var data = [
              { title: 'Marktkapitalisierung', value: profile.mktCap ? fmtNumber(profile.mktCap) : '–' },
              { title: 'KGV (PE)', value: profile.pe ? (Math.round(profile.pe*10)/10) : (ratios.priceEarningsRatio ? ratios.priceEarningsRatio : '–') },
              { title: 'Umsatz (letzte Periode)', value: income.revenue ? fmtNumber(income.revenue) : '–' },
              { title: 'EPS', value: (income.eps || profile.eps) ? (Math.round((income.eps||profile.eps)*100)/100) : '–' },
              { title: 'Free Cash Flow', value: cash.freeCashFlow ? fmtNumber(cash.freeCashFlow) : '–' },
              { title: 'EBITDA', value: income.ebitda ? fmtNumber(income.ebitda) : '–' },
              { title: 'Nettoergebnis', value: income.netIncome ? fmtNumber(income.netIncome) : '–' },
              { title: 'Dividende (letzter)', value: profile.lastDiv ? profile.lastDiv : (profile.dividendYield ? (Math.round(profile.dividendYield*1000)/10)+'%' : '–') },
              { title: 'Operative Marge', value: ratios.operatingMargin ? (Math.round(ratios.operatingMargin*1000)/10)+'%' : (ratios.operatingProfitMargin ? (Math.round(ratios.operatingProfitMargin*1000)/10)+'%' : '–') }
            ];

            renderFallback(data);
          }catch(e){ renderFallback(); }
        }).catch(function(){ renderFallback(); });
      }else{
        // No API key: render placeholder boxes so layout is visible
        // But only if TradingView didn't already inject 9 boxes
        var hasBoxes = container.classList.contains('three-by-three') || container.querySelector('.three-by-three-inner');
        var iframePresent = !!container.querySelector('iframe');
        if(!hasBoxes){
          // wait a short while to let TradingView potentially create DOM
          setTimeout(function(){
            var nowHas = container.classList.contains('three-by-three') || container.querySelector('.three-by-three-inner');
            if(!nowHas){ renderFallback(); }
          }, 700);
        }
      }
    })();
  </script>

  <!-- sizing handled by CSS (right column flex + iframe 100% height) -->

  <script>
    // Diagnostic helper: writes simple status messages into the financials box
    (function(){
      var container = document.getElementById('financials-overview');
      if(!container) return;
      function writeStatus(msg, level){
        var el = document.createElement('div');
        el.style.fontSize = '0.95rem';
        el.style.padding = '6px 0';
        el.style.color = (level==='error' ? '#b91c1c' : (level==='warn' ? '#92400e' : '#374151'));
        el.textContent = msg;
        // prepend so it's visible immediately
        container.insertBefore(el, container.firstChild);
      }

      // Key presence
      var key = window.FMP_API_KEY || null;
      writeStatus('FMP API Key: ' + (key ? 'gefunden' : 'nicht gefunden'), key ? 'ok' : 'warn');

      // Test proxy availability
      fetch('/api/financials/AAPL',{ method: 'GET' }).then(function(r){
        if(r.ok){ writeStatus('Lokaler Proxy: erreichbar (Status ' + r.status + ')', 'ok'); }
        else { writeStatus('Lokaler Proxy: antwortet mit Status ' + r.status, 'warn'); }
      }).catch(function(err){
        writeStatus('Lokaler Proxy: nicht erreichbar (' + String(err) + ')', 'warn');
      });

      // If key present, test direct FMP fetch
      if(key){
        var url = 'https://financialmodelingprep.com/api/v3/profile/AAPL?apikey=' + key;
        fetch(url).then(function(r){
          if(!r.ok){ writeStatus('Direkter FMP‑Abruf: Fehler Status ' + r.status, 'error'); return r.text().then(function(t){ writeStatus('Antwort: '+t.slice(0,200), 'warn'); }); }
          return r.json().then(function(j){ writeStatus('Direkter FMP‑Abruf: OK — Profil erhalten', 'ok'); });
        }).catch(function(err){ writeStatus('Direkter FMP‑Abruf: Fehler (' + String(err) + ') — CORS oder Netzwerk?', 'error'); });
      } else {
        writeStatus('Direkter FMP‑Abruf: übersprungen (kein Key)', 'warn');
      }
    })();
  </script>

</body>
</html>
