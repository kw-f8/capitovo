{
  "name": "capitovo Support Email Agent (Outlook)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/15 * * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Check Emails Every 15min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "folderName": "Inbox",
          "isRead": false
        },
        "options": {
          "downloadAttachments": false
        }
      },
      "id": "get-unread-emails",
      "name": "Get Unread Support Emails",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Classify and extract email details\nconst items = $input.all();\nconst processedEmails = [];\n\nfor (const item of items) {\n  const email = item.json;\n  \n  const subject = email.subject || '';\n  const body = email.bodyPreview || email.body?.content || '';\n  const from = email.from?.emailAddress?.address || '';\n  const fromName = email.from?.emailAddress?.name || '';\n  const messageId = email.id;\n  const receivedTime = email.receivedDateTime;\n  \n  // Keyword-based classification\n  const subjectLower = subject.toLowerCase();\n  const bodyLower = body.toLowerCase();\n  \n  let category = 'GENERAL';\n  let priority = 'MEDIUM';\n  let autoReply = false;\n  \n  // Technical Support\n  if (subjectLower.includes('fehler') || subjectLower.includes('error') || \n      subjectLower.includes('bug') || subjectLower.includes('problem') ||\n      bodyLower.includes('funktioniert nicht') || bodyLower.includes('geht nicht')) {\n    category = 'TECHNICAL_SUPPORT';\n    priority = 'HIGH';\n  }\n  \n  // Account Issues\n  else if (subjectLower.includes('login') || subjectLower.includes('passwort') || \n           subjectLower.includes('password') || subjectLower.includes('konto') ||\n           subjectLower.includes('account') || subjectLower.includes('zugang')) {\n    category = 'ACCOUNT_ISSUE';\n    priority = 'HIGH';\n  }\n  \n  // Billing / Subscription\n  else if (subjectLower.includes('rechnung') || subjectLower.includes('abonnement') ||\n           subjectLower.includes('zahlung') || subjectLower.includes('kÃ¼ndigung') ||\n           subjectLower.includes('subscription') || subjectLower.includes('payment')) {\n    category = 'BILLING';\n    priority = 'HIGH';\n  }\n  \n  // Content Requests\n  else if (subjectLower.includes('analyse') || subjectLower.includes('aktie') ||\n           subjectLower.includes('unternehmen') || subjectLower.includes('empfehlung') ||\n           bodyLower.includes('kÃ¶nnt ihr') || bodyLower.includes('wann kommt')) {\n    category = 'CONTENT_REQUEST';\n    priority = 'MEDIUM';\n    autoReply = true;\n  }\n  \n  // General Questions\n  else if (subjectLower.includes('frage') || subjectLower.includes('wie') ||\n           subjectLower.includes('was') || subjectLower.includes('info')) {\n    category = 'GENERAL_INQUIRY';\n    priority = 'MEDIUM';\n    autoReply = true;\n  }\n  \n  // Feedback / Suggestions\n  else if (subjectLower.includes('feedback') || subjectLower.includes('vorschlag') ||\n           subjectLower.includes('verbesserung') || subjectLower.includes('idee')) {\n    category = 'FEEDBACK';\n    priority = 'LOW';\n    autoReply = true;\n  }\n  \n  // Spam Detection\n  else if (subjectLower.includes('viagra') || subjectLower.includes('lottery') ||\n           subjectLower.includes('prince') || subjectLower.includes('casino') ||\n           from.includes('noreply') || from.includes('no-reply')) {\n    category = 'SPAM';\n    priority = 'LOW';\n  }\n  \n  processedEmails.push({\n    json: {\n      messageId: messageId,\n      from: from,\n      fromName: fromName,\n      subject: subject,\n      body: body,\n      receivedTime: receivedTime,\n      category: category,\n      priority: priority,\n      autoReply: autoReply,\n      originalEmail: email\n    }\n  });\n}\n\nreturn processedEmails;"
      },
      "id": "classify-emails",
      "name": "Classify & Extract",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.perplexity.ai/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "perplexityApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$credentials.apiKey}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"sonar\",\n  \"messages\": [{\"role\": \"system\", \"content\": \"Du bist der KI-Support-Agent von capitovo, einer Premium-Plattform fÃ¼r Aktienanalysen. Antworte professionell, hilfsbereit und prÃ¤zise auf Deutsch. Sei freundlich aber effizient. Bei technischen Problemen: Eskaliere an das Team. Bei Content-Anfragen: Verweise auf Content-Strategie und Roadmap.\"}, {\"role\": \"user\", \"content\": \"ðŸ“§ **SUPPORT-ANFRAGE**\\n\\n**Von:** {{$json.fromName}} ({{$json.from}})\\n**Betreff:** {{$json.subject}}\\n**Kategorie:** {{$json.category}}\\n**PrioritÃ¤t:** {{$json.priority}}\\n\\n**Nachricht:**\\n{{$json.body}}\\n\\n---\\n\\nðŸŽ¯ **Aufgabe:**\\nGeneriere eine professionelle, hilfreiche Antwort auf diese Support-Anfrage.\\n\\n**Richtlinien:**\\n1ï¸âƒ£ PersÃ¶nliche Anrede mit Namen\\n2ï¸âƒ£ Kurz und prÃ¤zise (max. 150 WÃ¶rter)\\n3ï¸âƒ£ Konkrete LÃ¶sungen oder nÃ¤chste Schritte\\n4ï¸âƒ£ Bei Account/Billing: Sicherheitshinweis + Eskalation\\n5ï¸âƒ£ Bei Content-Requests: Verweis auf Roadmap, ggf. Timeline\\n6ï¸âƒ£ Freundlicher Abschluss mit Support-Signatur\\n\\n**Antwortformat:**\\n[Nur die fertige Email-Antwort, keine Metakommentare]\"}],\n  \"temperature\": 0.3,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "generate-ai-response",
      "name": "Generate AI Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "perplexity-api-key",
          "name": "Perplexity API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.category}}",
              "operation": "notEquals",
              "value2": "SPAM"
            }
          ],
          "boolean": [
            {
              "value1": "={{$json.autoReply}}",
              "value2": true
            }
          ]
        },
        "combineOperation": "all"
      },
      "id": "filter-auto-reply",
      "name": "Auto-Reply Eligible?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "// Parse AI Response and prepare email\nconst aiResponse = $input.item.json.choices[0].message.content;\nconst originalData = $('Classify & Extract').item.json;\n\nreturn {\n  json: {\n    messageId: originalData.messageId,\n    to: originalData.from,\n    toName: originalData.fromName,\n    subject: `Re: ${originalData.subject}`,\n    body: aiResponse,\n    category: originalData.category,\n    priority: originalData.priority,\n    originalSubject: originalData.subject,\n    originalBody: originalData.body\n  }\n};"
      },
      "id": "prepare-reply",
      "name": "Prepare Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "operation": "reply",
        "messageId": "={{$json.messageId}}",
        "replyType": "replyAll",
        "message": "={{$json.body}}",
        "options": {}
      },
      "id": "send-outlook-reply",
      "name": "Send Outlook Reply",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [1250, 400],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "messageId": "={{$json.messageId}}",
        "options": {}
      },
      "id": "mark-as-read",
      "name": "Mark as Read",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [1450, 400],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "operation": "move",
        "messageId": "={{$json.messageId}}",
        "folderName": "Support/Auto-Replied",
        "options": {}
      },
      "id": "move-to-replied-folder",
      "name": "Move to Auto-Replied",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [1650, 400],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.priority}}",
              "operation": "equals",
              "value2": "HIGH"
            }
          ]
        }
      },
      "id": "check-high-priority",
      "name": "High Priority?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 180]
    },
    {
      "parameters": {
        "operation": "move",
        "messageId": "={{$json.messageId}}",
        "folderName": "Support/High-Priority",
        "options": {}
      },
      "id": "move-to-high-priority",
      "name": "Move to High-Priority",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [1050, 120],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "content": "=ðŸš¨ **HIGH PRIORITY SUPPORT EMAIL**\\n\\n**Von:** {{$json.fromName}} ({{$json.from}})\\n**Betreff:** {{$json.subject}}\\n**Kategorie:** {{$json.category}}\\n**Empfangen:** {{$json.receivedTime}}\\n\\n**Nachricht:**\\n```\\n{{$json.body.substring(0, 300)}}...\\n```\\n\\nâš ï¸ **Action Required:** Manuelle Bearbeitung empfohlen!\\nðŸ“§ **Email verschoben nach:** Support/High-Priority",
        "additionalFields": {}
      },
      "id": "slack-high-priority-alert",
      "name": "Slack: High Priority Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1250, 120],
      "credentials": {
        "slackApi": {
          "id": "slack-webhook",
          "name": "Slack Webhook"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.category}}",
              "operation": "equals",
              "value2": "SPAM"
            }
          ]
        }
      },
      "id": "check-spam",
      "name": "Is Spam?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 520]
    },
    {
      "parameters": {
        "operation": "move",
        "messageId": "={{$json.messageId}}",
        "folderName": "Junk Email",
        "options": {}
      },
      "id": "move-to-spam",
      "name": "Move to Spam",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [1050, 520],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "messageId": "={{$json.messageId}}",
        "options": {}
      },
      "id": "mark-spam-as-read",
      "name": "Mark Spam as Read",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [1250, 520],
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "outlook-support-account",
          "name": "Outlook Support Account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Generate daily summary\nconst allEmails = $input.all();\n\nconst stats = {\n  total: allEmails.length,\n  highPriority: 0,\n  autoReplied: 0,\n  spam: 0,\n  categories: {}\n};\n\nfor (const email of allEmails) {\n  const data = email.json;\n  \n  if (data.priority === 'HIGH') stats.highPriority++;\n  if (data.autoReply) stats.autoReplied++;\n  if (data.category === 'SPAM') stats.spam++;\n  \n  stats.categories[data.category] = (stats.categories[data.category] || 0) + 1;\n}\n\nreturn {\n  json: {\n    stats: stats,\n    timestamp: new Date().toISOString(),\n    date: new Date().toLocaleDateString('de-DE')\n  }\n};"
      },
      "id": "generate-summary",
      "name": "Generate Daily Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 650]
    },
    {
      "parameters": {
        "content": "=ðŸ“Š **Support Email Summary**\\n**Datum:** {{$json.date}}\\n\\nðŸ“§ **Gesamt:** {{$json.stats.total}} Emails\\nðŸš¨ **High Priority:** {{$json.stats.highPriority}}\\nðŸ¤– **Auto-Replied:** {{$json.stats.autoReplied}}\\nðŸ—‘ï¸ **Spam gefiltert:** {{$json.stats.spam}}\\n\\n**Kategorien:**\\n{{Object.entries($json.stats.categories).map(([cat, count]) => `â€¢ ${cat}: ${count}`).join('\\n')}}",
        "additionalFields": {}
      },
      "id": "slack-daily-summary",
      "name": "Slack: Daily Summary",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1250, 650],
      "credentials": {
        "slackApi": {
          "id": "slack-webhook",
          "name": "Slack Webhook"
        }
      },
      "disabled": true
    }
  ],
  "connections": {
    "Check Emails Every 15min": {
      "main": [
        [
          {
            "node": "Get Unread Support Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unread Support Emails": {
      "main": [
        [
          {
            "node": "Classify & Extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classify & Extract": {
      "main": [
        [
          {
            "node": "Check High Priority?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Auto-Reply Eligible?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Spam?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate Daily Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto-Reply Eligible?": {
      "main": [
        [
          {
            "node": "Generate AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate AI Response": {
      "main": [
        [
          {
            "node": "Prepare Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Reply": {
      "main": [
        [
          {
            "node": "Send Outlook Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Outlook Reply": {
      "main": [
        [
          {
            "node": "Mark as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Read": {
      "main": [
        [
          {
            "node": "Move to Auto-Replied",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check High Priority?": {
      "main": [
        [
          {
            "node": "Move to High-Priority",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Move to High-Priority": {
      "main": [
        [
          {
            "node": "Slack: High Priority Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Spam?": {
      "main": [
        [
          {
            "node": "Move to Spam",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Move to Spam": {
      "main": [
        [
          {
            "node": "Mark Spam as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Daily Summary": {
      "main": [
        [
          {
            "node": "Slack: Daily Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-30T00:00:00.000Z",
  "versionId": "1"
}
