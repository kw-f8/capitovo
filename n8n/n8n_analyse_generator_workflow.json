{
  "name": "capitovo Analyse Generator (Perplexity Pro)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "create-analysis",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "capitovo-analysis"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body || $input.item.json;\nconst company = body.company || 'Tesla';\nconst ticker = body.ticker || 'TSLA';\nconst sector = body.sector || 'ZYKLISCHER KONSUM';\n\nreturn {\n  json: {\n    company: company,\n    ticker: ticker,\n    sector: sector,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "process-input",
      "name": "Process Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $env.TEST_MODE }}",
              "operation": "equals",
              "value2": "true"
            }
          ]
        }
      },
      "id": "test-mode-check",
      "name": "Test Mode?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "const company = $input.item.json.company || 'Tesla';\nconst ticker = $input.item.json.ticker || 'TSLA';\nconst mockText = `## Marktbewertung und Aktienperformance\\n\\n- **Aktueller Kurs:** 123.45 USD\\n- **Marktkapitalisierung:** 800 Mrd. USD\\n- **52-Wochen-Hoch/Tief:** 150.00 / 95.00 USD\\n\\n## Bewertungsmultiples und Finanzkennzahlen\\n\\n| Kennzahl | Wert |\\n|----------|------|\\n| KGV | 25.0 |\\n| KBV | 8.5 |\\n| Umsatz | 100 Mrd. USD |\\n\\n## Analystenerwartungen\\n\\n- Durchschnittliches Kursziel: 135 USD\\n- Konsens: Halten\\n\\n## Fazit\\n\\nEmpfehlung: **Halten**`;\\n\\nreturn {\\n  json: {\\n    choices: [{\\n      message: {\\n        content: mockText\\n      }\\n    }],\\n    citations: []\\n  }\\n};"
      },
      "id": "mock-perplexity",
      "name": "Mock Perplexity",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 200]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json.choices[0].message.content;\nconst company = $('Process Input').item.json.company;\nconst ticker = $('Process Input').item.json.ticker;\nconst sector = $('Process Input').item.json.sector;\nconst date = new Date().toISOString().split('T')[0];\nconst filename = company.toLowerCase().replace(/\\s+/g, '-').replace(/[^a-z0-9-]/g, '');\n\nfunction markdownToHTML(markdown) {\n  return markdown\n    .replace(/### (.+)/g, '<h3>$1</h3>')\n    .replace(/## (.+)/g, '<h2>$1</h2>')\n    .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n    .replace(/^- (.+)/gm, '<li>$1</li>')\n    .replace(/(<li>.*<\\/li>)/s, '<ul>$1</ul>')\n    .replace(/\\n\\n/g, '</p><p>');\n}\n\nconst htmlContent = markdownToHTML(response);\nconst summary = company + ' Equity-Research-Bericht mit aktuellen Marktdaten.';\n\nreturn {\n  json: {\n    company: company,\n    ticker: ticker,\n    sector: sector,\n    filename: filename,\n    date: date,\n    summary: summary,\n    content: htmlContent,\n    raw: response\n  }\n};"
      },
      "id": "parse-response",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst html = `<!DOCTYPE html>\\n<html lang=\\"de\\">\\n<head>\\n    <meta charset=\\"utf-8\\">\\n    <meta name=\\"viewport\\" content=\\"width=device-width,initial-scale=1\\">\\n    <title>capitovo ‚Äî ${data.company} Analyse</title>\\n    <link href=\\"https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css\\" rel=\\"stylesheet\\">\\n    <link rel=\\"stylesheet\\" href=\\"../style.css\\">\\n</head>\\n<body class=\\"abonenten-page bg-white text-gray-900\\">\\n\\n<header>\\n    <div class=\\"header-content\\">\\n        <div class=\\"logo\\">\\n            <a href=\\"abonenten.html\\">\\n                <img src=\\"../caitavo_logo_wei√ü.png\\" alt=\\"capitovo Logo\\" class=\\"header-logo\\">\\n            </a>\\n        </div>\\n    </div>\\n</header>\\n\\n<main class=\\"max-w-4xl mx-auto p-6\\">\\n    <div class=\\"mb-4\\">\\n        <a href=\\"alle_analysen.html\\" class=\\"text-blue-600\\">‚Üê Zur√ºck</a>\\n    </div>\\n\\n    <article>\\n        <p class=\\"text-xs uppercase text-gray-500 mb-2\\">${data.sector} ‚Ä¢ ${data.ticker}</p>\\n        <h1 class=\\"text-3xl font-bold mb-4\\">${data.company}: Equity-Research-Bericht</h1>\\n        <p class=\\"text-sm text-gray-500 mb-6\\">capitovo Research ‚Ä¢ ${data.date}</p>\\n\\n        <div class=\\"prose max-w-none\\">\\n            ${data.content}\\n        </div>\\n\\n        <hr class=\\"my-8\\">\\n        <p class=\\"text-sm text-gray-600\\">\\n            <strong>Disclaimer:</strong> Diese Analyse stellt keine Anlageberatung dar.\\n        </p>\\n    </article>\\n</main>\\n\\n<footer class=\\"border-t py-6 mt-12 text-center text-sm text-gray-500\\">\\n    <div>&copy; 2025 capitovo ‚Äî Alle Rechte vorbehalten.</div>\\n</footer>\\n\\n<script src=\\"../script.js\\"></script>\\n</body>\\n</html>`;\n\nconst fs = require('fs');\nconst filepath = `/workspaces/capitovo/Abonenten/${data.filename}.html`;\nfs.writeFileSync(filepath, html, 'utf8');\n\nreturn {\n  json: {\n    success: true,\n    filepath: filepath,\n    filename: data.filename,\n    company: data.company,\n    ticker: data.ticker,\n    sector: data.sector,\n    date: data.date,\n    summary: data.summary\n  }\n};"
      },
      "id": "write-html",
      "name": "Write HTML File",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "jsCode": "const fs = require('fs');\nconst data = $input.item.json;\nconst jsonPath = '/workspaces/capitovo/data/analysen.json';\n\nlet analysen = [];\ntry {\n  analysen = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));\n} catch(e) {\n  console.log('Creating new analysen.json');\n}\n\nconst newEntry = {\n  id: `${data.ticker.toLowerCase()}-${data.date}`,\n  category: data.sector,\n  title: `${data.company}: Equity-Research-Bericht`,\n  summary: data.summary,\n  link: `Abonenten/${data.filename}.html`,\n  image: `data/vorschaubilder/${data.filename}.svg`,\n  date: data.date,\n  author: "capitovo Research",\n  tags: [data.company, data.ticker, data.sector],\n  published: true\n};\n\nanalysen.unshift(newEntry);\nfs.writeFileSync(jsonPath, JSON.stringify(analysen, null, 2), 'utf8');\n\nreturn {\n  json: {\n    success: true,\n    message: 'Analyse erfolgreich generiert!',\n    filename: data.filename,\n    company: data.company\n  }\n};"
      },
      "id": "update-json",
      "name": "Update analysen.json",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Input": {
      "main": [
        [
          {
            "node": "Test Mode?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Test Mode?": {
      "main": [
        [
          {
            "node": "Mock Perplexity",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Mock Perplexity": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Write HTML File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write HTML File": {
      "main": [
        [
          {
            "node": "Update analysen.json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update analysen.json": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-01T00:00:00.000Z",
  "versionId": "1"
}
            }
          ]
        },
        "options": {}
      },
      "id": "quality-check",
      "name": "Quality Check Agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 480],
      "credentials": {
        "httpHeaderAuth": {
          "id": "perplexity-api-key",
          "name": "Perplexity API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Parse Quality Check Results\nconst response = $input.item.json.choices[0].message.content;\nconst originalData = $('Parse Response').item.json;\n\n// Extract sections\nfunction extractSection(text, keyword) {\n  const regex = new RegExp(`##\\\\s*${keyword}[^#]*([\\\\s\\\\S]*?)(?=##|$)`, 'i');\n  const match = text.match(regex);\n  return match ? match[1].trim() : '';\n}\n\n// Extract Quality Score\nconst scoreMatch = response.match(/Quality Score[\\s\\S]*?(\\d+)\\s*\\/\\s*10/);\nconst qualityScore = scoreMatch ? parseInt(scoreMatch[1]) : 5;\n\n// Extract problems\nconst problems = extractSection(response, '‚ö†Ô∏è|Probleme|Identifizierte Probleme');\nconst suggestions = extractSection(response, 'üí°|Verbesserung');\nconst validations = extractSection(response, 'üìä|Kennzahlen');\n\nconst hasIssues = problems.length > 100 || qualityScore < 7;\n\nreturn {\n  json: {\n    company: originalData.company,\n    ticker: originalData.ticker,\n    qualityScore: qualityScore,\n    hasIssues: hasIssues,\n    problems: problems,\n    suggestions: suggestions,\n    validations: validations,\n    fullReport: response,\n    originalContent: originalData.content,\n    originalSummary: originalData.summary\n  }\n};"
      },
      "id": "parse-quality-check",
      "name": "Parse Quality Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 480]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.qualityScore}}",
              "operation": "larger",
              "value2": 6
            }
          ]
        }
      },
      "id": "check-quality-score",
      "name": "Quality Score OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1450, 480]
    },
          "Process Input": {
            "main": [
              [
                [
                  {
                    "node": "Test Mode?",
                    "type": "main",
                    "index": 0
                  }
                ]
              ]
            ]
          },
        "additionalFields": {}
      },
      "id": "alert-low-quality",
      "name": "Alert: Low Quality",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1650, 570],
      "credentials": {
        "slackApi": {
          "id": "slack-webhook",
          "name": "Slack Webhook"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Read current analysen.json\nconst fs = require('fs');\nconst path = '/workspaces/capitovo/data/analysen.json';\n\ntry {\n  const currentData = JSON.parse(fs.readFileSync(path, 'utf8'));\n  const metadata = $input.item.json.metadata;\n  const filename = $input.item.json.filename;\n  \n  // Create new entry\n  const newEntry = {\n    id: `${metadata.ticker.toLowerCase()}-${metadata.date}`,\n    category: metadata.sector,\n    title: `${metadata.company}: Equity-Research-Bericht`,\n    summary: metadata.summary,\n    link: `Abonenten/${filename}.html`,\n    image: `data/vorschaubilder/${filename}.svg`,\n    date: metadata.date,\n    author: \"capitovo Research\",\n    tags: [metadata.company, metadata.ticker, metadata.sector, \"Equity Research\"],\n    published: true\n  };\n  \n  // Add to beginning of array\n  currentData.unshift(newEntry);\n  \n  // Write back\n  fs.writeFileSync(path, JSON.stringify(currentData, null, 2), 'utf8');\n  \n  return {\n    json: {\n      success: true,\n      entry: newEntry,\n      message: `Analyse erfolgreich zu analysen.json hinzugef√ºgt`\n    }\n  };\n} catch (error) {\n  return {\n    json: {\n      success: false,\n      error: error.message\n    }\n  };\n}"
      },
      "id": "update-json",
      "name": "Update analysen.json",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "functionCode": "// Generate simple SVG placeholder\nconst company = $('Parse Response').item.json.company;\nconst ticker = $('Parse Response').item.json.ticker;\nconst filename = $input.item.json.filename;\n\nconst svg = `<svg width=\"640\" height=\"360\" viewBox=\"0 0 640 360\" xmlns=\"http://www.w3.org/2000/svg\">\n  <defs>\n    <linearGradient id=\"bg\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n      <stop offset=\"0%\" stop-color=\"#0f172a\" />\n      <stop offset=\"100%\" stop-color=\"#1e293b\" />\n    </linearGradient>\n  </defs>\n  <rect width=\"640\" height=\"360\" fill=\"url(#bg)\" rx=\"24\" />\n  <g transform=\"translate(60 60)\">\n    <text x=\"0\" y=\"12\" fill=\"#94a3b8\" font-family=\"'Inter', sans-serif\" font-size=\"14\" letter-spacing=\"0.2em\">${ticker}</text>\n    <text x=\"0\" y=\"56\" fill=\"#e2e8f0\" font-family=\"'Inter', sans-serif\" font-size=\"40\" font-weight=\"700\">${company}</text>\n    <text x=\"0\" y=\"96\" fill=\"#93c5fd\" font-family=\"'Inter', sans-serif\" font-size=\"18\">Equity Research ‚Ä¢ capitovo</text>\n  </g>\n  <g transform=\"translate(60 280)\" font-family=\"'Inter', sans-serif\" fill=\"#cbd5f5\">\n    <text x=\"0\" y=\"0\" font-size=\"16\">Marktbewertung ‚Ä¢ Kennzahlen ‚Ä¢ Ausblick</text>\n  </g>\n</svg>`;\n\nconst fs = require('fs');\nconst svgPath = `/workspaces/capitovo/data/vorschaubilder/${filename}.svg`;\nfs.writeFileSync(svgPath, svg, 'utf8');\n\nreturn {\n  json: {\n    success: true,\n    svgPath: svgPath,\n    filename: filename\n  }\n};"
      },
      "id": "generate-svg",
      "name": "Generate Preview SVG",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 480]
    },
    {
      "parameters": {
        "content": "=‚úÖ **Neue Analyse erstellt**\\n\\nüìä **Unternehmen:** {{$('Parse Response').item.json.company}} ({{$('Parse Response').item.json.ticker}})\\nüè¢ **Sektor:** {{$('Parse Response').item.json.sector}}\\nüìÖ **Datum:** {{$('Generate HTML').item.json.metadata.date}}\\nüîó **Link:** `/Abonenten/{{$('Generate HTML').item.json.filename}}.html`\\n\\n**Summary:** {{$('Parse Response').item.json.summary}}",
        "additionalFields": {}
      },
      "id": "slack-notification",
      "name": "Slack Notification",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1650, 300],
      "credentials": {
        "slackApi": {
          "id": "slack-webhook",
          "name": "Slack Webhook"
        }
      }
    },
    {
      "parameters": {
        "content": "=‚úÖ Analyse erfolgreich generiert!\\n\\n**Unternehmen:** {{$('Parse Response').item.json.company}}\\n**Ticker:** {{$('Parse Response').item.json.ticker}}\\n**Datei:** {{$('Generate HTML').item.json.filename}}.html\\n\\nDie Analyse wurde erstellt und ist nun verf√ºgbar.",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 480]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Input": {
      "main": [
        [
          {
            "node": "Test Mode?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Perplexity Research": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Test Mode?": {
      "main": [
        [
          {
            "node": "Mock Perplexity",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Perplexity Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mock Perplexity": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Quality Check Agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quality Check Agent": {
      "main": [
        [
          {
            "node": "Parse Quality Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Quality Check": {
      "main": [
        [
          {
            "node": "Quality Score OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quality Score OK?": {
      "main": [
        [
          {
            "node": "Write HTML File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Alert: Low Quality",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write HTML File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML": {
      "main": [
        [
          {
            "node": "Quality Score OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write HTML File": {
      "main": [
        [
          {
            "node": "Generate Preview SVG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Preview SVG": {
      "main": [
        [
          {
            "node": "Update analysen.json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update analysen.json": {
      "main": [
        [
          {
            "node": "Slack Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-30T00:00:00.000Z",
  "versionId": "1"
}
