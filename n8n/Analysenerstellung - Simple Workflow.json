{
  "name": "Analysenerstellung - Simple Workflow",
  "nodes": [
    {
      "parameters": {},
      "id": "820687c0-6274-4664-85d4-e50b46863ec4",
      "name": "ðŸ§ª Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1408,
        64
      ],
      "notes": "Einfach auf 'Execute workflow' klicken, kein Webhook nÃ¶tig."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "company",
              "name": "company",
              "type": "string",
              "value": "Ferrari N.V."
            },
            {
              "id": "ticker",
              "name": "ticker",
              "type": "string",
              "value": "RACE"
            },
            {
              "id": "sector",
              "name": "sector",
              "type": "string",
              "value": "ZYKLISCHER KONSUM"
            },
            {
              "id": "heroImage",
              "name": "heroImage",
              "type": "string",
              "value": "data/vorschaubilder_analysen/ferari.png"
            }
          ]
        },
        "options": {}
      },
      "id": "61076b75-46d0-4471-90c5-423b0f5fac3a",
      "name": "ðŸ“ Analyse-Input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -1200,
        64
      ],
      "notes": "Passe hier company/ticker/sector an fÃ¼r Tests."
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.perplexity.ai/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "perplexityApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"model\": \"sonar\",\n  \"temperature\": 0.35,\n  \"max_tokens\": 2000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Du bist ein Equity-Research-Autor. Schreibe eine wÃ¶chentliche Investment-Analyse im Stil professioneller Equity-Research-Berichte. Nutze Tabellen fÃ¼r Kennzahlen, schreibe auf Deutsch mit klarem, prÃ¤zisem Ton.\\n\\n**ANALYSEKONTEXT (VERBINDLICH)**\\nDiese Analyse ist Teil einer regelmÃ¤ÃŸig erscheinenden Berichtsserie. Wiederkehrende, langfristig stabile Basisinformationen nur dann ausfÃ¼hrlich darstellen, wenn sie sich materiell verÃ¤ndert haben oder fÃ¼r das aktuelle Marktumfeld neu relevant sind.\\n\\nFokus auf:\\n- Neue Entwicklungen\\n- Abweichungen gegenÃ¼ber frÃ¼heren Perioden\\n- VerÃ¤nderte Risiken, Chancen oder Bewertungen\\n\\nFalls keine signifikanten Ã„nderungen vorliegen, ist dies explizit zu benennen.\\n\\n**STRUKTUR DER ANALYSE**\\n\\n1. **Metadaten**: VollstÃ¤ndig und maschinenlesbar (Company, Ticker, Sektor, Datum)\\n\\n2. **KurzÃ¼berblick (Executive Summary)**:\\n   - Aktuelle Entwicklungen seit der letzten Analyse\\n   - Einordnung der derzeitigen Marktsituation\\n   - Wesentliche VerÃ¤nderungen bei Chancen und Risiken (stichpunktartig)\\n   - Keine Wiederholung bekannter Unternehmensgrundlagen\\n   - Keine eigene Bewertung, kein eigenes Kursziel\\n\\n3. **GeschÃ¤ftsmodell & Marktposition**:\\n   Nur ausfÃ¼hrlich erlÃ¤utern, wenn:\\n   - Strukturelle Ã„nderungen vorliegen\\n   - Neue GeschÃ¤ftsbereiche relevant werden\\n   - Sich die Wettbewerbssituation spÃ¼rbar verÃ¤ndert hat\\n   Andernfalls: Kurzverweis auf bestehendes Modell, Fokus auf VerÃ¤nderungen.\\n\\n4. **Fundamentale Kennzahlen**:\\n   Schwerpunkt auf VerÃ¤nderungen gegenÃ¼ber Vorperioden, Abweichungen von Trends und auffÃ¤lligen Entwicklungen. Stabile Kennzahlen ohne nennenswerte VerÃ¤nderung kurz einordnen, nicht detailliert wiederholen.\\n\\n5. **Bewertung**:\\n   Besonderes Augenmerk auf Bewertungsverschiebungen, ausgelÃ¶st durch:\\n   - Kursbewegungen\\n   - Gewinnrevisionen\\n   - VerÃ¤nderte Marktbedingungen\\n\\n6. **Wachstumstreiber & Risiken**:\\n   Nach AktualitÃ¤t priorisieren. Bereits bekannte Faktoren nur dann erneut ausfÃ¼hren, wenn sich deren Relevanz verÃ¤ndert hat.\\n\\n7. **Einordnung fÃ¼r Anleger**:\\n   KontextabhÃ¤ngig zur aktuellen Marktlage, nicht als dauerhafte Klassifizierung.\\n\\n**ANALYSTEN-KURSZIELE**\\nExterne Analysten-Kursziele ausschlieÃŸlich zitierend erwÃ¤hnen, wenn:\\n- Das Kursziel aus namentlich genannter, seriÃ¶ser Quelle stammt\\n- Die zugrunde liegende Argumentation kurz erlÃ¤utert wird\\n- Das Szenario konsistent mit der eigenen Analyse ist\\nWidersprÃ¼chliche oder extrem abweichende Kursziele nicht verwenden.\\n\\n**ABSCHLUSS**\\n- Kurzfazit\\n- Disclaimer (Keine Anlageberatung, eigenstÃ¤ndige PrÃ¼fung erforderlich)\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Erstelle eine vollstÃ¤ndige Analyse fÃ¼r: Unternehmen {{ $json.company }}, Ticker {{ $json.ticker }}, Sektor {{ $json.sector }}\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "a7166aa7-4eb2-4a60-86b5-b7818152e773",
      "name": "ðŸ¤– Perplexity Draft",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -1008,
        64
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "dm5vgTUJUPgIVq9x",
          "name": "Header Auth account"
        },
        "perplexityApi": {
          "id": "Zq4IFTAGurh3vkp3",
          "name": "Perplexity account"
        }
      },
      "notes": "Erzeugt den Analyse-Entwurf."
    },
    {
      "parameters": {
        "jsCode": "const res = $input.item.json;\nconst draft = res.choices?.[0]?.message?.content || '';\nif (!draft) throw new Error('Kein Draft erhalten');\n\nconst input = $('ðŸ“ Analyse-Input').item.json;\nconst date = new Date().toISOString().split('T')[0];\n\nfunction slugify(t){return t.toLowerCase().replace(/[Ã¤Ã¶Ã¼ÃŸ]/g,c=>({Ã¤:'ae',Ã¶:'oe',Ã¼:'ue',ÃŸ:'ss'}[c])).replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,60)||'analyse';}\nconst filename = slugify(input.company);\n\nreturn { json: { ...input, date, filename, draft } };"
      },
      "id": "3ecba91f-3506-40ff-be1c-98a74961855c",
      "name": "ðŸ§© Normalisieren",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        64
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.perplexity.ai/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "perplexityApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"model\": \"sonar\",\n  \"temperature\": 0.15,\n  \"max_tokens\": 1000,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"PrÃ¼fe den folgenden Text auf QualitÃ¤t (Struktur, ZahlenplausibilitÃ¤t, Stil). Antworte als JSON: {\\\"quality_score\\\":1-10, \\\"issues\\\":string, \\\"improved_content\\\":string}. Liefere improved_content nur, wenn quality_score < 7.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Text: {{ $json.draft }}\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "17f638bf-db0b-4f5f-91b3-e4f4439f7921",
      "name": "ðŸ” QA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -608,
        64
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "dm5vgTUJUPgIVq9x",
          "name": "Header Auth account"
        },
        "perplexityApi": {
          "id": "Zq4IFTAGurh3vkp3",
          "name": "Perplexity account"
        }
      },
      "notes": "QualitÃ¤tsprÃ¼fung via Perplexity."
    },
    {
      "parameters": {
        "jsCode": "// Hole QA-Antwort\nconst qa = $input.item.json;\nconst content = qa.choices?.[0]?.message?.content || '{}';\n\n// Hole Daten vom vorherigen Normalisieren-Node Ã¼ber $node\nconst prevData = $node['ðŸ§© Normalisieren'].json;\nconst baseDraft = prevData.draft;\nconst company = prevData.company;\nconst ticker = prevData.ticker;\nconst sector = prevData.sector;\nconst date = prevData.date;\nconst filename = prevData.filename;\nconst heroImage = prevData.heroImage;\n\nlet score = 5, issues = 'unbekannt', improved = '';\n\n// Parse QA response\ntry {\n  let jsonStr = content;\n  const codeBlockMatch = content.match(/```json?([\\s\\S]*?)```/);\n  if (codeBlockMatch) {\n    jsonStr = codeBlockMatch[1];\n  }\n  const parsed = JSON.parse(jsonStr.trim());\n  score = parsed.quality_score ?? score;\n  issues = parsed.issues || 'Keine';\n  improved = parsed.improved_content || '';\n} catch (e) {\n  const scoreMatch = content.match(/quality_score[\\\"']?\\s*[:=]\\s*(\\d+)/i);\n  if (scoreMatch) score = parseInt(scoreMatch[1]);\n  issues = 'QA-JSON nicht parsebar';\n}\n\nconst finalContent = (score < 7 && improved && improved.length > 100) ? improved : baseDraft;\n\nreturn {\n  json: {\n    company,\n    ticker,\n    sector,\n    date,\n    filename,\n    heroImage,\n    qualityScore: score,\n    issues,\n    content: finalContent,\n    qaRaw: content.substring(0, 500)\n  }\n};"
      },
      "id": "67d66864-59ff-4381-a9c5-4aaba22dd33a",
      "name": "ðŸ“Š QA auswerten",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        64
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "ok",
              "leftValue": "={{ $json.qualityScore }}",
              "rightValue": 5,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0ceb9b5d-3c76-44fd-b3d2-c5f4d333e89f",
      "name": "âœ… Score >= 5?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -208,
        64
      ]
    },
    {
      "parameters": {
        "jsCode": "const d = $input.item.json;\nreturn { json: { status: 'fail', reason: 'Quality too low', qualityScore: d.qualityScore, issues: d.issues } };"
      },
      "id": "1097b9ee-7114-4eba-a2c7-20ceaa2e465b",
      "name": "â›” Ergebnis (Fail)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        176
      ]
    },
    {
      "parameters": {
        "jsCode": "const d = $input.item.json;\n\n// Formatiere die fertige Analyse als kopierbaren Text\nconst output = `\n=====================================\nFERTIGE ANALYSE - KOPIERBEREIT\n=====================================\n\nUnternehmen: ${d.company}\nTicker: ${d.ticker}\nSektor: ${d.sector}\nDatum: ${d.date}\nQuality Score: ${d.qualityScore}/10\nIssues: ${d.issues}\n\n-------------------------------------\nINHALT:\n-------------------------------------\n\n${d.content}\n\n-------------------------------------\nDATEIEN:\n-------------------------------------\nFilename: ${d.filename}.html\nHero Image: ${d.heroImage}\n\n=====================================\n`;\n\nreturn { json: {\n  status: 'ok',\n  qualityScore: d.qualityScore,\n  issues: d.issues,\n  company: d.company,\n  ticker: d.ticker,\n  sector: d.sector,\n  date: d.date,\n  filename: d.filename,\n  content: d.content,\n  formattedOutput: output\n}};"
      },
      "id": "2e402747-d492-43d6-8167-9782fab745eb",
      "name": "ðŸ“¤ Fertige Analyse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -144
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "ðŸ§ª Manual Trigger": {
      "main": [
        [
          {
            "node": "ðŸ“ Analyse-Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“ Analyse-Input": {
      "main": [
        [
          {
            "node": "ðŸ¤– Perplexity Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ¤– Perplexity Draft": {
      "main": [
        [
          {
            "node": "ðŸ§© Normalisieren",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ§© Normalisieren": {
      "main": [
        [
          {
            "node": "ðŸ” QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ” QA": {
      "main": [
        [
          {
            "node": "ðŸ“Š QA auswerten",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“Š QA auswerten": {
      "main": [
        [
          {
            "node": "âœ… Score >= 5?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Score >= 5?": {
      "main": [
        [
          {
            "node": "ðŸ“¤ Fertige Analyse",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â›” Ergebnis (Fail)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ðŸ“¤ Fertige Analyse": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "91a7398c-5d87-4253-b469-4ed4cab71d9e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "4e6dd7bd1638bd2724994ec7815d8c03087481a498a8122e7ad8e8a16988a92b"
  },
  "id": "jDbMz9A05WiKb8t4",
  "tags": [
    {
      "updatedAt": "2025-12-27T13:08:15.535Z",
      "createdAt": "2025-12-27T13:08:15.535Z",
      "id": "uOHqDzYBQsUIXFcP",
      "name": "funktionsfÃ¤hig"
    }
  ]
}