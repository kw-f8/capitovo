<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>capitovo — Abonnement verwalten</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <script>
        // Run before body paint: set a class on <html> based on stored session
        // to prevent a flash of incorrect subscription text/badges.
        (function(){
            try{
                var raw = localStorage.getItem('capitovo_session');
                var sub = 'free';
                if(raw){
                    try{ var obj = JSON.parse(raw); if(obj && obj.subscription) sub = obj.subscription; }catch(e){}
                }
                if(sub === 'premium') document.documentElement.classList.add('cap-sub-premium');
                else document.documentElement.classList.add('cap-sub-free');
            }catch(e){}
        })();
    </script>
</head>
<body class="bg-white text-gray-900 abonenten-page">
    <header>
        <div class="header-content">
            <div class="logo">
                <a href="./abonenten.html">
                    <img src="../assets/capitovo_logo_weiß.png" alt="capitovo Logo" class="header-logo">
                </a>
            </div>
            <button class="menu-toggle" id="menu-toggle" aria-controls="sidebar" aria-expanded="false" aria-label="Menü öffnen">☰</button>
        </div>
    </header>

    <main class="max-w-[1200px] mx-auto pl-6 pr-10 py-12">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="p-6 flex items-start justify-between gap-4">
                    <div>
                        <h1 class="text-2xl font-bold">Abonnement verwalten</h1>
                        <p id="header-subtext" class="text-sm text-gray-500 mt-1">
                            <span class="subtext-free">Der kostenlose Zugang bietet Ihnen einen ersten Eindruck der Funktionen.<br>Mit einem kostenpflichtigen Abonnement erhalten Sie den vollständigen Zugriff auf alle Inhalte und Funktionen.</span>
                            <span class="subtext-premium">Ändern Sie Ihr Abonnement jederzeit. Anpassungen gelten ab dem nächsten Abrechnungszeitraum.</span>
                        </p>
                    </div>
                    <a href="./konto.html" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition-colors" aria-label="Zurück">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Zurück
                    </a>
                </div>

            <div class="p-6">
                <div class="prose max-w-none">
                    

                    <div class="mt-4 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch mb-6">
                            <!-- Free -->
                            <div id="card-free" class="plan-card bg-white rounded-xl shadow-xl border-4 border-transparent p-8 flex flex-col justify-between hover:shadow-2xl transition-all duration-300 cursor-pointer h-full" onclick="selectPlan('free')">
                                <div class="relative">
                                    <span id="selected-badge-free" class="absolute -top-10 left-4 text-white text-xs font-bold uppercase py-1 px-3 rounded-full shadow-md hidden" style="background-color:var(--color-accent-blue);">Aktuelles Abonnement</span>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Free</h3>
                                    <div class="text-4xl font-extrabold text-gray-900 mb-4">€ 0,- <span class="text-xl font-normal text-gray-500">/ Monat</span></div>

                                    <div class="plan-details w-full">
                                        <ul class="text-left space-y-3 mb-10 text-gray-700 w-full">
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-green-500 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                Wöchentliche Markt-Bulletins
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-green-500 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                2 exklusive Aktienanalysen / Monat
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-red-500 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                Zugang zum Performance-Dashboard
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-red-500 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                Exklusive Webinare & Q&A
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <button class="select-plan-btn w-full block py-3 px-8 border border-gray-300 rounded-lg shadow-sm text-base font-medium text-gray-900 bg-white hover:bg-gray-100 transition duration-150 mt-4">Wählen</button>
                            </div>

                            <!-- Premium -->
                            <div id="card-premium" class="plan-card bg-primary-blue rounded-xl shadow-xl border-4 border-transparent p-8 flex flex-col justify-between cursor-pointer h-full" onclick="selectPlan('premium')">
                                <div class="relative">
                                    <span id="premium-badge" class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-gray-900 text-xs font-bold uppercase py-1 px-3 rounded-full shadow-md">Empfohlen</span>
                                    <span id="selected-badge-premium" class="absolute -top-10 left-4 text-white text-xs font-bold uppercase py-1 px-3 rounded-full shadow-md hidden" style="background-color:var(--color-accent-blue);">Aktuelles Abonnement</span>
                                    <h3 class="text-2xl font-bold text-white mb-4">Premium</h3>
                                    <div class="text-4xl font-extrabold text-white mb-4">€ 14,99 <span class="text-xl font-normal text-blue-200">/ Monat</span></div>

                                    <div class="plan-details w-full">
                                        <ul class="text-left space-y-3 mb-10 text-white w-full">
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-yellow-400 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                Alle Free-Funktionen
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-yellow-400 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                <strong>Alle</strong> exklusiven Aktienanalysen (4+ / Monat)
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-yellow-400 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                Zugang zum Performance-Dashboard
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-yellow-400 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                Exklusive Webinare & Q&A
                                            </li>
                                            <li class="flex items-start">
                                                <svg class="w-5 h-5 text-yellow-400 mr-2 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                14-tägige Geld-zurück-Garantie
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <button class="select-plan-btn w-full block py-3 px-8 border border-white rounded-lg shadow-lg text-base font-medium text-primary-blue bg-white hover:bg-blue-100 transition duration-150 mt-4">Wählen</button>
                            </div>

                            <!-- (No Lifetime) -->
                        </div>

                        <div class="border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center text-xl font-extrabold text-gray-900 mt-4">
                                <span>Gesamt</span>
                                <span id="summary-total">€ 0,-</span>
                            </div>
                            <div class="mt-1 text-xs text-gray-500 text-right">inkl. MwSt.</div>
                            <div id="summary-next-billing" class="mt-2 text-sm text-gray-600 text-right">Nächste Abrechnung: -</div>
                        </div>

                        <!-- Top save/cancel buttons removed per request -->

                        <!-- Confirm Free Modal -->
                            <!-- Confirm Free Modal (moved to end of body to avoid layout/transform issues) -->
                    </div>

                    <!-- Hinweis removed per request -->
                </div>
            </div>
        </div>

        <!-- Kündigen Abschnitt (eigenständiger Kasten, nur für Premium sichtbar) -->
        <div id="cancel-box" class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="p-6">
                <h3 class="text-lg font-semibold">Abonnement kündigen</h3>
                <p class="text-sm text-gray-600 mt-2">Wenn Sie Ihr Abonnement kündigen möchten, klicken Sie auf "Kündigen". Ihr Zugang bleibt bis zum Ende des bereits bezahlten Zeitraums aktiv.</p>
                <div class="mt-4">
                    <button type="button" id="confirm-cancel" class="px-4 py-2 bg-red-600 text-white rounded-md">Kündigen</button>
                    <button type="button" id="cancel-abort" class="ml-3 px-4 py-2 border border-gray-300 rounded-md">Zurück zur Startseite</button>
                </div>
            </div>
        </div>
    </main>

    <footer id="abo" class="site-footer" data-scroll="fade-up" data-scroll-delay="40">
        <div class="footer-inner max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row items-center justify-between gap-4">
            <p class="copyright text-sm text-gray-600">&copy; 2024 capitovo. Wachstum durch Wissen.</p>

            <div class="footer-links flex items-center gap-3">
                <a href="../Rechtliches/impressum.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Impressum</a>
                <a href="../Rechtliches/datenschutz.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Datenschutz</a>
                <a href="../Rechtliches/haftung.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Haftungsausschluss</a>
                <a href="../Rechtliches/agb.html" class="footer-btn" target="_blank" rel="noopener noreferrer">AGB</a>
            </div>
        </div>
    </footer>

    <!-- Confirm Free Modal (moved here to mirror login modal placement) -->
    <div id="confirm-free-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-xl-custom flex items-center justify-center p-4" style="z-index: 1001;">
        <div class="w-full max-w-xl">
            <div class="bg-white p-6 rounded-lg shadow-xl border border-gray-200 overflow-visible">
                <h4 class="text-lg font-bold mb-2">Abonnement kündigen</h4>
                <p class="text-sm text-gray-700 mb-3">Sie können Ihr Abonnement jederzeit kündigen.</p>
                <p class="text-sm text-gray-700 mb-4">Es entstehen keine weiteren Kosten. Ihr Zugang bleibt bis zum Ende des aktuellen Abrechnungszeitraums bestehen.</p>
                <div class="flex w-full justify-between items-center">
                    <button type="button" id="confirm-free-cancel" class="px-4 py-2 border rounded-md flex-none">Abbrechen</button>
                    <button type="button" id="confirm-free-accept" class="px-4 py-2 bg-red-600 text-white rounded-md ml-3 flex-1 text-center">Kündigen und zum Free Abonnement wechseln</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sessionKey = 'capitovo_session';
            const stored = JSON.parse(localStorage.getItem(sessionKey) || 'null') || {};
            // Normalize stored subscription value to a lowercase plan key when possible
            let currentPlan = (stored && stored.subscription) ? String(stored.subscription).toLowerCase() : null;
            // update header subtext based on subscription
            const headerSubtextEl = document.getElementById('header-subtext');
            if(headerSubtextEl){
                if(stored && stored.subscription === 'premium'){
                    headerSubtextEl.innerHTML = 'Ändern Sie Ihr Abonnement jederzeit. Anpassungen gelten ab dem nächsten Abrechnungszeitraum.';
                } else {
                    headerSubtextEl.innerHTML = 'Der kostenlose Zugang bietet Ihnen einen ersten Eindruck der Funktionen.<br>Mit einem kostenpflichtigen Abonnement erhalten Sie den vollständigen Zugriff auf alle Inhalte und Funktionen.';
                }
            }

            const plans = {
                free: { price: '€ 0,-' },
                premium: { price: '€ 14,99' }
            };

            const totalEl = document.getElementById('summary-total');
            const subtotalEl = document.getElementById('summary-subtotal');

            const premiumBadge = document.getElementById('premium-badge');
            const selectedBadgeFree = document.getElementById('selected-badge-free');
            const selectedBadgePremium = document.getElementById('selected-badge-premium');
            const urlParams = new URLSearchParams(window.location.search);
            const forcedPlan = urlParams.get('plan');

            function updateUIForSelection(planKey){
                ['free','premium'].forEach(key => {
                    const card = document.getElementById(`card-${key}`);
                    const btn = card.querySelector('.select-plan-btn');

                    if(key === planKey){
                        card.classList.remove('border-transparent','opacity-60');
                        card.classList.add('shadow-2xl');

                        // Use Capitovo blue for selected borders via CSS variable
                        card.style.borderColor = 'var(--color-accent-blue)';

                        btn.textContent = 'Ausgewählt';
                        btn.classList.remove('bg-white','text-gray-900','text-primary-blue','border-gray-300','border-white','hover:bg-gray-100','hover:bg-blue-100');
                        // Make the selected button have a white background
                        btn.classList.add('bg-white','text-gray-900','border-transparent','cursor-default','shadow-inner');
                    } else {
                        card.classList.add('border-transparent','opacity-90');
                        card.classList.remove('border-blue-500','border-yellow-400','z-10','z-20','shadow-2xl');
                        card.style.borderColor = '';

                        btn.textContent = 'Wählen';
                        btn.classList.remove('bg-gray-900','text-white','border-transparent','cursor-default','shadow-inner');

                        if(key === 'premium') btn.classList.add('bg-white','text-primary-blue','border-white','hover:bg-blue-100');
                        else btn.classList.add('bg-white','text-gray-900','border-gray-300','hover:bg-gray-100');
                    }
                });

                // update totals
                const p = plans[planKey];
                const nextBillingEl = document.getElementById('summary-next-billing');
                if(p){
                    if(subtotalEl) subtotalEl.textContent = p.price;
                    if(totalEl) totalEl.textContent = p.price + ' / Monat';
                } else {
                    if(subtotalEl) subtotalEl.textContent = '€ 0,-';
                    if(totalEl) totalEl.textContent = '€ 0,-';
                }
                if(nextBillingEl){
                    // Align behavior with konto.html:
                    // - compute next date from `ts`
                    // - only use stored.nextPayment if it's a real date string (ignore placeholders like '-')
                    const rawNext = (stored && typeof stored.nextPayment === 'string') ? stored.nextPayment.trim() : '';
                    const isPlaceholder = !rawNext || rawNext === '-' || rawNext === '–' || rawNext.toLowerCase() === 'null' || rawNext.toLowerCase() === 'undefined';
                    let nb = isPlaceholder ? '' : rawNext;

                    const isPremiumLike = (planKey === 'premium') || (currentPlan === 'premium') || (stored && String(stored.subscription || '').toLowerCase() === 'premium');
                    if (!nb && isPremiumLike) {
                        const startDateObj = (stored && stored.ts) ? new Date(stored.ts) : new Date();
                        const nextDateObj = new Date(startDateObj);
                        nextDateObj.setMonth(nextDateObj.getMonth() + 1);
                        nb = nextDateObj.toLocaleDateString('de-DE');
                    }

                    nextBillingEl.textContent = 'Nächste Abbuchung: ' + (nb || '-');
                }

                // show selected badges
                if(selectedBadgeFree) selectedBadgeFree.style.display = (planKey === 'free') ? 'inline-block' : 'none';
                if(selectedBadgePremium) selectedBadgePremium.style.display = (planKey === 'premium') ? 'inline-block' : 'none';
            }

            window.selectPlan = function(planKey){
                // If user has Free and selects Premium, go to checkout
                if(planKey === 'premium' && stored && stored.subscription === 'free' && currentPlan !== 'premium'){
                    try{
                        const target = '../checkout.html';
                        const w = window.open(target, '_blank');
                        if (w && typeof w.focus === 'function') w.focus();
                        return;
                    }catch(e){ /* fallback to normal flow if opening a new tab fails */ }
                }

                // If selecting Free while session shows Premium, prompt confirmation
                if(planKey === 'free' && stored.subscription === 'premium' && stored.subscription !== null && currentPlan !== 'free'){
                    const modal = document.getElementById('confirm-free-modal');
                    if(modal) {
                        // remove any old error hints inside modal (match login modal behavior)
                        const existingError = modal.querySelector('#confirm-free-error');
                        if (existingError) existingError.remove();
                        // Close sidebar like login modal does
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar) {
                            sidebar.classList.remove('open');
                            sidebar.style.transform = '';
                            sidebar.style.display = '';
                            sidebar.style.opacity = '';
                            sidebar.style.pointerEvents = '';
                            sidebar.setAttribute('aria-hidden', 'true');
                        }
                        const menuToggle = document.getElementById('menu-toggle') || document.querySelector('.menu-toggle');
                        if (menuToggle) menuToggle.setAttribute('aria-expanded', 'false');

                        modal.classList.remove('hidden');
                        // focus primary action for keyboard users
                        const primaryBtn = modal.querySelector('#confirm-free-accept');
                        if (primaryBtn && typeof primaryBtn.focus === 'function') primaryBtn.focus();
                        document.body.style.overflow = 'hidden'; // prevent background scrolling (like login modal)
                    }
                    return;
                }

                currentPlan = planKey;
                updateUIForSelection(planKey);
                // update URL param (optional)
                try{
                    const url = new URL(window.location);
                    url.searchParams.set('plan', planKey);
                    window.history.replaceState({}, '', url);
                }catch(e){}
                // update premium badge when selection changes
                if(premiumBadge){
                    if(forcedPlan === 'premium' || currentPlan === 'premium' || (stored && stored.subscription === 'premium')){
                        premiumBadge.style.display = 'none';
                    } else {
                        premiumBadge.style.display = '';
                        premiumBadge.textContent = 'Empfohlen';
                        premiumBadge.classList.remove('bg-green-400','text-white');
                        premiumBadge.classList.add('bg-yellow-400','text-gray-900');
                    }
                }
            };

            // if URL forces a plan, show it as selected
            if(forcedPlan && plans[forcedPlan]){
                currentPlan = forcedPlan;
                updateUIForSelection(forcedPlan);
            } else {
                // initialize UI from stored session
                // Try to normalize stored subscription and always run updateUIForSelection
                if(currentPlan && plans[currentPlan]){
                    updateUIForSelection(currentPlan);
                } else {
                    // ensure the next billing is displayed even when plan keys differ;
                    // pass 'free' as visual default but the function will prefer stored.nextPayment
                    updateUIForSelection('free');
                }
            }
            // If stored session indicates premium, hide the recommended badge
            if(premiumBadge){
                if(forcedPlan === 'premium' || (stored && stored.subscription === 'premium') || currentPlan === 'premium'){
                    premiumBadge.style.display = 'none';
                } else {
                    premiumBadge.style.display = '';
                    premiumBadge.textContent = 'Empfohlen';
                    premiumBadge.classList.remove('bg-green-400','text-white');
                    premiumBadge.classList.add('bg-yellow-400','text-gray-900');
                }
            }

            const savePlanBtn = document.getElementById('save-plan');
            if (savePlanBtn) {
                savePlanBtn.addEventListener('click', function(){
                    const s = stored || {};
                    s.subscription = currentPlan || null;
                    if(s.subscription === 'premium'){
                        // compute next payment date one month from now
                        const d = new Date();
                        d.setMonth(d.getMonth() + 1);
                        try{ s.nextPayment = d.toLocaleDateString('de-DE'); }catch(e){ s.nextPayment = '–'; }
                    } else s.nextPayment = '-';
                    localStorage.setItem(sessionKey, JSON.stringify(s));
                    alert('Ihr Abonnement wurde aktualisiert. Änderungen sind jetzt aktiv.');
                    window.location.href = './konto.html';
                });
            }

            const confirmCancelBtn = document.getElementById('confirm-cancel');
            if (confirmCancelBtn) {
                confirmCancelBtn.addEventListener('click', function(){
                    // Open the same confirm-free modal so user sees the same flow
                    const modal = document.getElementById('confirm-free-modal');
                    if(modal){
                        // remove any old error hints
                        const existingError = modal.querySelector('#confirm-free-error');
                        if (existingError) existingError.remove();
                        // Close sidebar like login modal does
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar) {
                            sidebar.classList.remove('open');
                            sidebar.style.transform = '';
                            sidebar.style.display = '';
                            sidebar.style.opacity = '';
                            sidebar.style.pointerEvents = '';
                            sidebar.setAttribute('aria-hidden', 'true');
                        }
                        const menuToggle = document.getElementById('menu-toggle') || document.querySelector('.menu-toggle');
                        if (menuToggle) menuToggle.setAttribute('aria-expanded', 'false');
                        modal.classList.remove('hidden');
                        const primaryBtn = modal.querySelector('#confirm-free-accept');
                        if (primaryBtn && typeof primaryBtn.focus === 'function') primaryBtn.focus();
                        document.body.style.overflow = 'hidden';
                    }
                });
            }

            const abortBtn = document.getElementById('cancel-abort');
            if (abortBtn) {
                abortBtn.addEventListener('click', function(){
                    window.location.href = './abonenten.html';
                });
            }

            // Modal handlers for confirming switch from Premium -> Free
            const modalCancel = document.getElementById('confirm-free-cancel');
            const modalAccept = document.getElementById('confirm-free-accept');
            const modalEl = document.getElementById('confirm-free-modal');
            if(modalCancel){
                modalCancel.addEventListener('click', function(e){
                    if (e && typeof e.preventDefault === 'function') { e.preventDefault(); e.stopPropagation(); }
                    if(modalEl) modalEl.classList.add('hidden');
                    document.body.style.overflow = '';
                });
            }
            if(modalAccept){
                modalAccept.addEventListener('click', function(e){
                    if (e && typeof e.preventDefault === 'function') { e.preventDefault(); e.stopPropagation(); }
                    // set stored subscription to free and persist
                    const s = stored || {};
                    s.subscription = 'free';
                    s.nextPayment = '-';
                    try{ localStorage.setItem(sessionKey, JSON.stringify(s)); }catch(err){}
                    if(modalEl) modalEl.classList.add('hidden');
                    document.body.style.overflow = '';
                    // apply selection visually
                    try{ selectPlan('free'); }catch(err){}
                    try{ alert('Ihr Abonnement wurde gekündigt und auf Free gesetzt.'); }catch(e){}
                });
            }
        });
    </script>
    <script src="../script.js?v=6"></script>
    <!-- Sidebar (members) -->
    <div class="sidebar" id="sidebar" aria-hidden="true" aria-label="Seitenmenü">
        <button class="close-button" id="close-sidebar" aria-label="Sidebar schließen">&times;</button>
        <nav class="sidebar-nav" aria-label="Hauptnavigation">
            <ul>
                <li>
                    <a href="./abonenten.html" class="flex items-center space-x-3" aria-label="Startseite">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M3 11.5L12 4l9 7.5" />
                            <path d="M5 10.5v7.5a1 1 0 001 1h3v-5h6v5h3a1 1 0 001-1v-7.5" />
                        </svg>
                        <span>Startseite</span>
                    </a>
                </li>
                <!-- upper logout removed to avoid duplicate; keep single logout at bottom -->
                <li>
                    <div>
                        <a href="./konto.html" class="flex items-center space-x-3" aria-label="Mein Konto">
                            <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5" />
                                <path d="M6 20c0-3.333 3.333-6 6-6s6 2.667 6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Mein Konto</span>
                        </a>
                        <!-- Kontaktdaten-Link entfernt per Wunsch -->
                    </div>
                </li>
                <li>
                    <a href="./alle_analysen.html" class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="10" width="4" height="11" rx="0.5" /><rect x="10" y="6" width="4" height="15" rx="0.5" /><rect x="17" y="3" width="4" height="18" rx="0.5" /></svg>
                        <span>Analysen</span>
                    </a>
                </li>
                <li>
                    <a href="./Aktien-Monitor/aktien-monitor.html" class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M3 17l6-6 4 4 8-8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                            <polyline points="3 17 9 11 13 15 21 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                        <span>Aktien‑Monitor</span>
                    </a>
                </li>
                <li>
                    <a href="./earnings_kalender.html" class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span>Wirtschaftskalender</span>
                    </a>
                </li>

                <!-- Kontakt button at bottom -->
                <li class="logout-bottom">
                    <a href="#" id="open-contact-modal" class="flex items-center space-x-3" aria-label="Kontakt aufnehmen">
                        <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 6l-10 7L2 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Kontakt</span>
                    </a>
                </li>

                <!-- Logout button moved to bottom via .logout-bottom -->
                <li class="logout-bottom">
                    <a href="#" id="logout-link" class="logout-link" aria-label="Abmelden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <path d="M16 17l5-5-5-5" />
                            <path d="M21 12H9" />
                        </svg>
                        <span>Abmelden</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Contact Modal -->
    <div id="contact-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-xl-custom flex items-center justify-center p-4" style="z-index: 1001;">
        <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl border border-gray-200 relative overflow-hidden max-h-[90vh] overflow-y-auto">
            <button id="close-contact-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <div class="p-8 md:p-10">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Kontakt aufnehmen</h2>

                <form id="contact-form-modal" action="#" method="POST" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="relative">
                            <input type="text" id="contact-name" name="name" required
                                class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm"
                                placeholder="Ihr Name">
                            <label for="contact-name"
                                   class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                          peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                          peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                                Ihr Name
                            </label>
                        </div>
                        <div class="relative">
                            <input type="email" id="contact-email" name="email" required
                                class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm"
                                placeholder="Ihre E-Mail">
                            <label for="contact-email"
                                   class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                          peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                          peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                                Ihre E-Mail
                            </label>
                        </div>
                    </div>

                    <div class="relative">
                        <select id="contact-category" name="category" required
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm bg-white">
                            <option value="" disabled selected>Bitte wählen</option>
                            <option value="support">Technischer Support</option>
                            <option value="billing">Rechnung & Abonnement</option>
                            <option value="feedback">Feedback & Vorschläge</option>
                            <option value="other">Sonstiges</option>
                        </select>
                        <label for="contact-category"
                               class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                      peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                      peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Kategorie
                        </label>
                    </div>

                    <div class="relative">
                        <textarea id="contact-message" name="message" rows="4" required
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm"
                            placeholder="Ihre Nachricht"></textarea>
                        <label for="contact-message"
                               class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                      peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                      peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Ihre Nachricht
                        </label>
                    </div>

                    <div class="relative">
                        <input type="number" id="contact-captcha" name="captcha" required
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm"
                            placeholder="Sicherheitsfrage: Was ist 3 + 2?">
                        <label for="contact-captcha"
                               class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                      peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                      peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Sicherheitsfrage: Was ist 3 + 2?
                        </label>
                    </div>

                    <div class="text-center">
                        <button type="submit" id="contact-submit" disabled
                            class="inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-gray-400 cursor-not-allowed transition duration-150">
                            Nachricht senden
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Contact Modal Logic
        const openContactModalBtn = document.getElementById('open-contact-modal');
        const closeContactModalBtn = document.getElementById('close-contact-modal');
        const contactModal = document.getElementById('contact-modal');
        const contactForm = document.getElementById('contact-form-modal');
        const contactCaptcha = document.getElementById('contact-captcha');
        const contactSubmit = document.getElementById('contact-submit');

        if (openContactModalBtn && contactModal) {
            openContactModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                contactModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            });

            const closeModal = () => {
                contactModal.classList.add('hidden');
                document.body.style.overflow = '';
            };

            if (closeContactModalBtn) closeContactModalBtn.addEventListener('click', closeModal);

            contactModal.addEventListener('click', (e) => {
                if (e.target === contactModal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !contactModal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }

        // Captcha Logic
        if (contactCaptcha && contactSubmit) {
            contactCaptcha.addEventListener('input', function() {
                if (this.value === '5') {
                    contactSubmit.disabled = false;
                    contactSubmit.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    contactSubmit.classList.add('bg-accent-blue', 'hover:bg-blue-700');
                } else {
                    contactSubmit.disabled = true;
                    contactSubmit.classList.add('bg-gray-400', 'cursor-not-allowed');
                    contactSubmit.classList.remove('bg-accent-blue', 'hover:bg-blue-700');
                }
            });
        }

        // Form Submission (Mock)
        if (contactForm) {
            contactForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const btn = contactSubmit;
                const originalText = btn.innerText;

                btn.disabled = true;
                btn.innerText = 'Wird gesendet...';

                setTimeout(() => {
                    btn.innerText = 'Gesendet!';
                    btn.classList.remove('bg-accent-blue', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600');

                    setTimeout(() => {
                        contactModal.classList.add('hidden');
                        document.body.style.overflow = '';
                        contactForm.reset();
                        btn.innerText = originalText;
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        btn.disabled = true;
                    }, 1500);
                }, 1000);
            });
        }
    </script>
</body>
</html>
