<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrieren - capitovo</title>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png?v=2025-12-25b">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16.png?v=2025-12-25b">
    <link rel="shortcut icon" href="assets/favicon-32.png?v=2025-12-25b">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png?v=2025-12-25a">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Remove black outline/frame from sidebar toggle while keeping an accessible focus-visible ring */
        #menu-toggle, .menu-toggle { border: none; outline: none; background: transparent; }
        #menu-toggle:focus, .menu-toggle:focus { outline: none; box-shadow: none; }
        /* Provide a subtle visible focus for keyboard users */
        #menu-toggle:focus-visible, .menu-toggle:focus-visible { box-shadow: 0 0 0 4px rgba(59,130,246,0.12); border-radius: 8px; }

        /* Verification modal: resend button should use capitovo blue and grey out while disabled */
        #resend-code { color: #111827; font-weight: 600; }
        #resend-code:hover { color: var(--color-accent-blue); }
        #resend-code:disabled { color: #9ca3af !important; cursor: not-allowed; }

        /* Verification modal: confirm button should grey out while disabled */
        #verify-submit:disabled { background-color: #9ca3af !important; cursor: not-allowed; }
        #verify-submit:disabled:hover { background-color: #9ca3af !important; }

        /* Keep hint area height stable and allow line breaks */
        #verification-hint {
            min-height: 3rem;
            white-space: pre-line;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
            /* Zurück-Button: dezenter Leuchteffekt in capitovo-blau (wie in Abonenten/vorlage.html) */
            .back-btn-glow { box-shadow: none; transition: box-shadow 0.18s cubic-bezier(0.65,0,0.35,1), background-color 0.14s; }
            .back-btn-glow:hover, .back-btn-glow:focus-visible {
                box-shadow: 0 0 0 2px rgba(0,145,214,0.10), 0 0 4px 1px rgba(0,145,214,0.08);
            }
        </style>
</head>
<body style="background-color: #fff;" class="flex flex-col min-h-screen">

    <header>
        <div class="header-content">
            <div class="logo">
                <a href="index.html">
                    <img src="assets/capitovo_logo_weiß.png" alt="capitovo Logo" class="header-logo">
                </a>
            </div>
            <!-- Optional: Menu Toggle if needed, or just a link back -->
            <a href="index.html" class="inline-flex items-center gap-2 text-sm font-medium text-gray-700 bg-white border border-2 border-[color:var(--color-accent-blue)] rounded-md px-3 py-2 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-200 back-btn-glow">
                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Zurück zur Startseite
            </a>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" style="margin-top:-100px;">
        <div class="max-w-xl w-full space-y-8 bg-white p-10 rounded-xl shadow-xl border border-gray-200">
            <div>
                <h2 class="mt-2 text-center text-3xl font-extrabold text-gray-900">
                    Konto erstellen
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Oder <a href="https://kw-f8.github.io/capitovo/index.html#open-login" class="font-medium text-accent-blue hover:text-accent-blue font-bold" style="color: var(--color-accent-blue);">melden Sie sich an</a>, wenn Sie bereits ein Konto haben
                </p>
            </div>
            <form id="registration-form" class="mt-8 space-y-6" action="#" method="POST">
                <div class="space-y-5">
                    <div class="relative">
                        <input id="firstname" name="firstname" type="text" autocomplete="given-name" required 
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm" 
                            placeholder="Vorname">
                        <label for="firstname" 
                            class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Vorname
                        </label>
                    </div>
                    <div class="relative">
                        <input id="lastname" name="lastname" type="text" autocomplete="family-name" required 
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm" 
                            placeholder="Nachname">
                        <label for="lastname" 
                            class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Nachname
                        </label>
                    </div>
                    <div class="relative">
                        <input id="email-address" name="email" type="email" autocomplete="email" required 
                               class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm" 
                               placeholder="E-Mail-Adresse">
                        <label for="email-address" 
                               class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                      peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                      peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            E-Mail-Adresse
                        </label>
                    </div>
                    <div class="relative">
                        <input id="password" name="password" type="password" autocomplete="new-password" required 
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm pr-10" 
                            placeholder="Passwort">
                        <label for="password" 
                            class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Passwort
                        </label>
                        <button type="button" id="toggle-password" tabindex="-1" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-accent-blue focus:outline-none" aria-label="Passwort anzeigen">
                            <svg id="icon-password" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg>
                        </button>
                    </div>
                    <div class="relative">
                        <input id="password-confirm" name="password-confirm" type="password" autocomplete="new-password" required 
                            class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm" 
                            placeholder="Passwort bestätigen">
                        <label for="password-confirm" 
                            class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Passwort bestätigen
                        </label>
                        <p id="password-match-error" class="hidden text-red-500 text-xs mt-1 ml-1">Die Passwörter stimmen nicht überein.</p>
                    </div>
                </div>

                <div class="flex items-center">
                    <input id="terms" name="terms" type="checkbox" required class="h-4 w-4 text-accent-blue focus:ring-accent-blue border-gray-300 rounded">
                    <label for="terms" class="ml-2 block text-sm text-gray-900">
                        Ich stimme den <a href="Rechtliches/agb.html" class="font-medium text-accent-blue hover:text-accent-blue font-bold" style="color: var(--color-accent-blue);">AGB</a> und der <a href="Rechtliches/datenschutz.html" class="font-medium text-accent-blue hover:text-accent-blue font-bold" style="color: var(--color-accent-blue);">Datenschutzerklärung</a> zu
                    </label>
                </div>
                <div class="mt-4 w-full flex justify-center">
                    <!-- Cloudflare Turnstile Platzhalter -->
                    <div id="turnstile-placeholder" style="width: 100%; max-width: 340px; height: 80px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 1rem; border: 1px dashed #cbd5e1;">
                        Sicherheitsabfrage (Cloudflare Turnstile)
                    </div>
                </div>

                <div>
                    <button id="register-button" type="submit" disabled class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-gray-400 cursor-not-allowed transition duration-150">
                        Registrieren
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Verification Modal -->
    <div id="verification-modal" class="hidden fixed inset-0 z-[1001] bg-black bg-opacity-75 backdrop-blur-xl-custom flex items-center justify-center p-4">
        <div class="w-full max-w-sm">
            <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200 relative">
                <button id="close-verification" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                
                <h2 class="text-2xl font-semibold text-gray-900 mb-2 text-center">E-Mail bestätigen</h2>
                <p id="verification-hint" class="text-sm text-gray-600 text-center mb-6">
                    Wir haben einen Code an Ihre E-Mail-Adresse gesendet. Bitte geben Sie ihn unten ein.
                </p>
                
                <form id="verification-form" class="space-y-6">
                    <div class="relative">
                        <input id="verification-code" name="code" type="text" required 
                               class="peer appearance-none rounded-md block w-full px-3 py-3 border border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:ring-accent-blue focus:border-accent-blue focus:z-10 sm:text-sm" 
                               placeholder="Bestätigungscode">
                        <label for="verification-code" 
                               class="absolute left-3 -top-2.5 bg-white px-1 text-xs text-gray-500 transition-all duration-200
                                      peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:bg-transparent
                                      peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-accent-blue peer-focus:bg-white">
                            Bestätigungscode
                        </label>
                    </div>

                    <div>
                        <button id="verify-submit" type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-blue hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150">
                            Konto bestätigen
                        </button>
                    </div>
                    
                    <div class="text-center text-sm">
                        <button id="resend-code" type="button">Code erneut senden</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Registrierung erfolgreich Modal (15s sichtbar, danach Redirect zum Login) -->
    <div id="registration-success-modal" class="hidden fixed inset-0 z-[1002] bg-black bg-opacity-75 backdrop-blur-xl-custom flex items-center justify-center p-4">
        <div class="w-full max-w-sm">
            <div class="bg-white p-6 rounded-lg shadow-xl border border-gray-200 text-center">
                <h2 class="text-2xl font-semibold text-gray-900 mb-2">Registrierung erfolgreich</h2>
                <p class="text-sm text-gray-600">Sie haben sich erfolgreich registriert</p>
                <p class="text-sm text-gray-600">Sie werden automatisch zum Login weitergeleitet</p>

                <div class="mt-5 flex justify-center">
                    <div class="relative" style="width:96px; height:96px;">
                        <svg viewBox="0 0 100 100" width="96" height="96" aria-hidden="true" class="block">
                            <circle id="registration-success-progress" cx="50" cy="50" r="42" fill="none" stroke-width="8" stroke-linecap="round"
                                style="stroke: var(--color-accent-blue); transform: rotate(-90deg); transform-origin: 50% 50%; stroke-dasharray: 0; stroke-dashoffset: 0;"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-xl font-semibold text-gray-900">
                                <span id="registration-success-countdown">15</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer mt-auto" data-scroll="fade-up" data-scroll-delay="40">
        <div class="footer-inner max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col md:flex-row items-center justify-between gap-4">
            <p class="copyright text-sm text-gray-600">&copy; 2024 capitovo. Wachstum durch Wissen.</p>

            <div class="footer-links flex items-center gap-3">
                <a href="Rechtliches/impressum.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Impressum</a>
                <a href="Rechtliches/datenschutz.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Datenschutz</a>
                <a href="Rechtliches/haftung.html" class="footer-btn" target="_blank" rel="noopener noreferrer">Haftungsausschluss</a>
                <a href="Rechtliches/agb.html" class="footer-btn" target="_blank" rel="noopener noreferrer">AGB</a>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Passwort anzeigen/ausblenden Funktion
            // Gemeinsames Ein-/Ausblenden für beide Passwortfelder
            const passwordInput = document.getElementById('password');
            const passwordConfirmInput = document.getElementById('password-confirm');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const iconPassword = document.getElementById('icon-password');
            if (togglePasswordBtn && passwordInput && passwordConfirmInput && iconPassword) {
                togglePasswordBtn.addEventListener('click', function() {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    passwordConfirmInput.type = isPassword ? 'text' : 'password';
                    // Minimalistisches Auge (optional: durchgestrichen bei sichtbar)
                    if (iconPassword) {
                        if (isPassword) {
                            iconPassword.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3" stroke-width="2"/><line x1="4" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="2"/>';
                        } else {
                            iconPassword.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/><circle cx="12" cy="12" r="3" stroke-width="2"/>';
                        }
                    }
                });
            }
            const form = document.getElementById('registration-form');
            const password = document.getElementById('password');
            const confirm = document.getElementById('password-confirm');
            const errorMsg = document.getElementById('password-match-error');
            const submitBtn = document.getElementById('register-button');
            const confirmLabel = document.querySelector('label[for="password-confirm"]');

            function validateForm() {
                const p1 = password.value;
                const p2 = confirm.value;
                let passwordsMatch = true;

                // 1. Passwort-Vergleich
                if (p2.length > 0) {
                    if (p1 !== p2) {
                        passwordsMatch = false;
                        // Fehler anzeigen
                        confirm.classList.remove('border-gray-300', 'focus:border-accent-blue', 'focus:ring-accent-blue');
                        confirm.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                        errorMsg.classList.remove('hidden');
                        if(confirmLabel) {
                            confirmLabel.classList.add('text-red-500');
                            confirmLabel.classList.remove('peer-focus:text-accent-blue');
                            confirmLabel.classList.add('peer-focus:text-red-500');
                        }
                    } else {
                        // Kein Fehler
                        confirm.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                        confirm.classList.add('border-gray-300', 'focus:border-accent-blue', 'focus:ring-accent-blue');
                        errorMsg.classList.add('hidden');
                        if(confirmLabel) {
                            confirmLabel.classList.remove('text-red-500');
                            confirmLabel.classList.remove('peer-focus:text-red-500');
                            confirmLabel.classList.add('peer-focus:text-accent-blue');
                        }
                    }
                } else {
                    // Reset wenn leer
                    confirm.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
                    confirm.classList.add('border-gray-300', 'focus:border-accent-blue', 'focus:ring-accent-blue');
                    errorMsg.classList.add('hidden');
                    if(confirmLabel) {
                        confirmLabel.classList.remove('text-red-500');
                        confirmLabel.classList.remove('peer-focus:text-red-500');
                        confirmLabel.classList.add('peer-focus:text-accent-blue');
                    }
                }

                // 2. Button Status
                // CheckValidity prüft 'required', 'email' etc.
                const isFormValid = form.checkValidity();
                
                if (isFormValid && passwordsMatch && p1 === p2 && p1.length > 0) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-primary-blue', 'hover:bg-blue-700');
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.remove('bg-primary-blue', 'hover:bg-blue-700');
                }
            }

            // Event Listeners
            if(form) {
                const inputs = form.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', validateForm);
                    input.addEventListener('change', validateForm);
                    input.addEventListener('keyup', validateForm);
                });

                // Handle Registration Submit
                form.addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent actual submission
                    // Show Verification Modal
                    document.getElementById('verification-modal').classList.remove('hidden');
                });
            }

            // Handle Verification Modal Close
            const closeVerificationBtn = document.getElementById('close-verification');
            if(closeVerificationBtn) {
                closeVerificationBtn.addEventListener('click', function() {
                    document.getElementById('verification-modal').classList.add('hidden');
                    resetVerificationState();
                    lockResendOnNextOpen = true;

                    // Rate limit: nach 2x Schließen -> Sperre setzen (Timer läuft im Hintergrund weiter)
                    // Während einer aktiven Sperre NICHT neu starten/verlängern.
                    if (!isVerificationLocked()) {
                        verificationCloseCount += 1;
                        if (verificationCloseCount >= 2) {
                            verificationLockUntil = Date.now() + VERIFICATION_LOCK_DURATION_MS;
                            verificationCloseCount = 0;
                            requireManualCodeRequest = true;
                        }
                    }
                });
            }

            // --- Code Verification & Resend Logic ---
            let currentVerificationCode = null;
            let resendTimeout = null;
            let resendCountdown = 0;
            let lockResendOnNextOpen = false;
            let verificationLockUntil = 0;
            let verificationCloseCount = 0;
            let verificationLockTimer = null;
            let requireManualCodeRequest = false;
            let verificationSuccessTimeout = null;
            const VERIFICATION_LOCK_DURATION_MS = 60 * 1000; // 1 Minute zum Testen
            const verificationForm = document.getElementById('verification-form');
            const resendBtn = document.getElementById('resend-code');
            const codeInput = document.getElementById('verification-code');
            const defaultCodePlaceholder = codeInput ? codeInput.getAttribute('placeholder') : 'Bestätigungscode';
            const verifySubmitBtn = verificationForm ? verificationForm.querySelector('button[type="submit"]') : null;
            const verificationHint = document.getElementById('verification-hint');
            const defaultVerificationHintText = verificationHint ? verificationHint.textContent.trim() : '';

            function isVerificationLocked() {
                return Date.now() < verificationLockUntil;
            }

            function setVerificationHint(text, isError) {
                if (!verificationHint) return;
                verificationHint.textContent = text;
                verificationHint.classList.toggle('text-red-600', !!isError);
                verificationHint.classList.toggle('text-gray-600', !isError);
            }

            function setVerificationControlsDisabled(disabled) {
                if (codeInput) codeInput.disabled = disabled;
                if (verifySubmitBtn) verifySubmitBtn.disabled = disabled;
                if (resendBtn) resendBtn.disabled = disabled ? true : resendBtn.disabled;
            }

            function clearVerificationLockTimer() {
                if (verificationLockTimer) {
                    clearInterval(verificationLockTimer);
                    verificationLockTimer = null;
                }
            }

            function applyVerificationLockState() {
                requireManualCodeRequest = true;

                // stop resend countdowns while locked
                if (resendTimeout) {
                    clearInterval(resendTimeout);
                    resendTimeout = null;
                }
                resendCountdown = 0;

                const update = () => {
                    const remainingMs = Math.max(0, verificationLockUntil - Date.now());
                    const remainingSec = Math.ceil(remainingMs / 1000);
                    const mm = String(Math.floor(remainingSec / 60)).padStart(1, '0');
                    const ss = String(remainingSec % 60).padStart(2, '0');
                    setVerificationHint(`Zu viele Versuche\nBitte warten Sie ${mm}:${ss} und versuchen Sie es erneut`, true);
                    if (remainingSec <= 0) {
                        clearVerificationLockTimer();
                        // Lock ist vorbei: kein automatischer Code-Versand.
                        // Nutzer muss einen neuen Code über "Code erneut senden" anfordern.
                        currentVerificationCode = null;
                        setVerificationHint('Bitte fordern Sie einen neuen Code an', false);
                        if (codeInput) {
                            codeInput.disabled = false;
                            codeInput.value = '';
                            codeInput.setAttribute('placeholder', 'Bitte neuen Code über „Code erneut senden“ anfordern');
                        }
                        if (resendBtn) {
                            resendBtn.disabled = false;
                            resendBtn.textContent = 'Code erneut senden';
                        }
                        if (verifySubmitBtn) {
                            verifySubmitBtn.disabled = true;
                        }
                    }
                };

                setVerificationControlsDisabled(true);
                if (resendBtn) {
                    resendBtn.disabled = true;
                    resendBtn.textContent = 'Code erneut senden';
                }
                update();
                clearVerificationLockTimer();
                verificationLockTimer = setInterval(update, 1000);
            }

            // Dummy: Code generieren (in echt: vom Server)
            function generateCode() {
                // 6-stelliger Code
                return Math.floor(100000 + Math.random() * 900000).toString();
            }

            // Dummy: Code per Mail senden (hier nur in Variable speichern)
            function sendVerificationCode() {
                currentVerificationCode = generateCode();
                // In echt: Code an Backend senden, das Mail verschickt
                // console.log('Neuer Code:', currentVerificationCode);
            }

            // Sperrt den Resend-Button für 60 Sekunden
            function startResendCooldown() {
                if (resendTimeout) {
                    clearInterval(resendTimeout);
                    resendTimeout = null;
                }
                resendCountdown = 60;
                if (resendBtn) {
                    resendBtn.disabled = true;
                    resendBtn.textContent = `Code erneut senden (${resendCountdown}s)`;
                }
                resendTimeout = setInterval(() => {
                    resendCountdown--;
                    if (resendBtn) {
                        if (resendCountdown > 0) {
                            resendBtn.textContent = `Code erneut senden (${resendCountdown}s)`;
                        } else {
                            resendBtn.textContent = 'Code erneut senden';
                            resendBtn.disabled = false;
                            clearInterval(resendTimeout);
                            resendTimeout = null;
                        }
                    }
                }, 1000);
            }

            function resetVerificationState() {
                // Code ungültig machen
                currentVerificationCode = null;

                if (verificationSuccessTimeout) {
                    clearTimeout(verificationSuccessTimeout);
                    verificationSuccessTimeout = null;
                }

                clearVerificationLockTimer();

                // Timer stoppen
                if (resendTimeout) {
                    clearInterval(resendTimeout);
                    resendTimeout = null;
                }
                resendCountdown = 0;

                // UI zurücksetzen
                if (resendBtn) {
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Code erneut senden';
                }
                if (codeInput) {
                    codeInput.value = '';
                    codeInput.setAttribute('placeholder', defaultCodePlaceholder);
                    codeInput.disabled = false;
                }
                if (verifySubmitBtn) {
                    verifySubmitBtn.disabled = false;
                }
                if (verificationHint && defaultVerificationHintText) {
                    setVerificationHint(defaultVerificationHintText, false);
                }
            }

            // Zeigt ein modales Bestätigungsfenster nach erfolgreicher Registrierung an,
            // das 15 Sekunden sichtbar bleibt und dann zur Login-Seite weiterleitet.
            let registrationSuccessInterval = null;
            function showRegistrationSuccessModal() {
                // Schließe das Verifizierungsmodal und setze Status zurück
                if (verificationModal) verificationModal.classList.add('hidden');
                resetVerificationState();

                const successModal = document.getElementById('registration-success-modal');
                if (!successModal) {
                    // Falls das Modal aus irgendeinem Grund fehlt, fallback: direkt weiterleiten.
                    window.location.replace('index.html#open-login');
                    return;
                }

                successModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Countdown + Ring-Progress (15s) und danach Redirect
                if (registrationSuccessInterval) {
                    clearInterval(registrationSuccessInterval);
                    registrationSuccessInterval = null;
                }

                const totalMs = 15000;
                const start = Date.now();
                let lastShownSeconds = null;

                const countdownEl = document.getElementById('registration-success-countdown');
                const progressEl = document.getElementById('registration-success-progress');

                const radius = 42;
                const circumference = 2 * Math.PI * radius;
                if (progressEl) {
                    progressEl.style.strokeDasharray = String(circumference);
                    progressEl.style.strokeDashoffset = '0';
                }

                const tick = () => {
                    const elapsed = Date.now() - start;
                    const remainingMs = Math.max(0, totalMs - elapsed);
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    const progress = remainingMs / totalMs; // 1 -> 0

                    if (countdownEl && remainingSeconds !== lastShownSeconds) {
                        countdownEl.textContent = String(remainingSeconds);
                        lastShownSeconds = remainingSeconds;
                    }

                    if (progressEl) {
                        const dashOffset = circumference * (1 - progress);
                        progressEl.style.strokeDashoffset = String(dashOffset);
                    }

                    if (remainingMs <= 0) {
                        clearInterval(registrationSuccessInterval);
                        registrationSuccessInterval = null;
                        window.location.replace('index.html#open-login');
                    }
                };

                // initial paint
                tick();
                registrationSuccessInterval = setInterval(tick, 50);
            }

            // Beim Öffnen des Modals: Code generieren und senden
            const verificationModal = document.getElementById('verification-modal');
            if (verificationModal) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            if (!verificationModal.classList.contains('hidden')) {
                                // Wenn gesperrt: keine Codes senden, nur Meldung + deaktivieren
                                if (isVerificationLocked()) {
                                    applyVerificationLockState();
                                    return;
                                }

                                // normaler Start
                                setVerificationControlsDisabled(false);
                                setVerificationHint(defaultVerificationHintText, false);

                                // Falls vorher gesperrt war: kein automatischer Code, Nutzer muss neu anfordern.
                                if (requireManualCodeRequest) {
                                    currentVerificationCode = null;
                                    setVerificationHint('Bitte fordern Sie einen neuen Code an', false);
                                    if (codeInput) {
                                        codeInput.value = '';
                                        codeInput.setAttribute('placeholder', 'Bitte neuen Code über „Code erneut senden“ anfordern');
                                    }
                                    if (verifySubmitBtn) {
                                        verifySubmitBtn.disabled = true;
                                    }
                                    if (resendBtn) {
                                        resendBtn.disabled = false;
                                        resendBtn.textContent = 'Code erneut senden';
                                    }
                                    // kein 60s-Autolock in diesem Zustand
                                    lockResendOnNextOpen = false;
                                } else {
                                    sendVerificationCode();
                                    if (codeInput) {
                                        codeInput.value = '';
                                        codeInput.setAttribute('placeholder', defaultCodePlaceholder);
                                    }

                                    // Wenn das Modal zuvor geschlossen wurde: Button direkt 60s sperren (wie "geklickt")
                                    if (lockResendOnNextOpen) {
                                        startResendCooldown();
                                        lockResendOnNextOpen = false;
                                    } else {
                                        if (resendBtn) {
                                            resendBtn.disabled = false;
                                            resendBtn.textContent = 'Code erneut senden';
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
                observer.observe(verificationModal, { attributes: true });
            }

            // Resend-Button-Logik
            if (resendBtn) {
                resendBtn.addEventListener('click', function() {
                    if (isVerificationLocked()) {
                        applyVerificationLockState();
                        return;
                    }
                    sendVerificationCode();
                    requireManualCodeRequest = false;
                    if (codeInput) codeInput.setAttribute('placeholder', defaultCodePlaceholder);
                    if (verifySubmitBtn) verifySubmitBtn.disabled = false;
                    startResendCooldown();
                });
            }

            // Formular-Submit: Dummy-Validierung
            if(verificationForm) {
                verificationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
                    if (isVerificationLocked()) {
                        applyVerificationLockState();
                        return;
                    }
                    // Solange die echte E-Mail-Verifikation noch nicht aktiv ist:
                    // festen Test-Code zulassen (z.B. 1234)
                    const enteredCode = codeInput ? String(codeInput.value || '').trim() : '';
                    if (enteredCode === '1234') {
                        if (verificationSuccessTimeout) {
                            clearTimeout(verificationSuccessTimeout);
                            verificationSuccessTimeout = null;
                        }
                        // Zeige das Success-Modal und leite nach 15s weiter
                        showRegistrationSuccessModal();
                        return;
                    }
                    if (!currentVerificationCode) {
                        if (codeInput) {
                            codeInput.value = '';
                            codeInput.setAttribute('placeholder', 'Bitte zuerst einen neuen Code über „Code erneut senden“ anfordern');
                        }
                        if (verifySubmitBtn) verifySubmitBtn.disabled = true;
                        return;
                    }
                    // In echt: Code an Backend schicken und prüfen
                    // Hier: Nur Vergleich mit currentVerificationCode
                    if (enteredCode && enteredCode === currentVerificationCode) {
                        if (verificationSuccessTimeout) {
                            clearTimeout(verificationSuccessTimeout);
                            verificationSuccessTimeout = null;
                        }
                        // Zeige das Success-Modal und leite nach 15s weiter
                        showRegistrationSuccessModal();
                        return;
                    } else {
                        codeInput.value = '';
                        codeInput.placeholder = 'Falscher Code!';
                    }
                });
            }
        });
    </script>
    <script src="script.js?v=6"></script>
</body>
</html>
